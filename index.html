<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=360, height=640, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { width: 360px; height: 640px; overflow: hidden; background: #ffffff; font-family: Arial, sans-serif; }
  .header { width: 360px; height: 32px; background: #0b6fd8; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; }
  .title { font-size: 14px; font-weight: bold; }
  .icons { display: flex; }
  .icon { width: 14px; height: 14px; border: 1px solid #fff; border-radius: 2px; margin-left: 6px; }
  .dots { width: 4px; height: 4px; background: #fff; border-radius: 50%; margin-left: 8px; box-shadow: 0 6px 0 #fff, 0 -6px 0 #fff; }
  .under-area { width: 360px; background: #A7C6E2; padding: 5px; height: calc(640px - 32px); overflow-y: auto; }
  .scan-btn { width: 100%; height: 40px; background: #2E7D32; color: white; font-size: 18px; font-weight: bold; border: none; border-radius: 5px; margin-bottom: 5px; cursor: pointer; }
  .under-header { font-weight: bold; margin: 5px 0; }
  .grid { width: 360px; }
  .row { display: flex; }
  .cell { width: 18px; height: 22px; border: 1px solid #999; background: #E2E8D3; text-align: center; font-size: 14px; line-height: 22px; }
  .orange { background: #F49A16; }
  .gray { background: #A9A9A9; }
  .select-status-header { width: 100%; height: 32px; background: #0b6fd8; color: white; display: flex; align-items: center; padding-left: 8px; margin: 10px 0; font-weight: bold; }
  .status-select { width: 100%; height: 40px; font-size: 16px; margin-bottom: 10px; }
  .gps-status { font-size: 12px; color: #0b6fd8; margin: 5px 0; display: flex; align-items: center; gap: 5px; }
  .gps-dot { width: 8px; height: 8px; border-radius: 50%; background: #FFA500; display: inline-block; }
  .gps-dot.active { background: #28a745; }
  .label-bar { font-weight: bold; margin: 5px 0; }
  .status-message { text-align: center; font-weight: bold; padding: 10px; min-height: 40px; }
  .success { color: #28a745; } .error { color: #dc3545; } .sending { color: #0b6fd8; }
  .footer { width: 360px; height: 28px; background: #0b6fd8; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; margin-top: 10px; }
  .footer-icons { display: flex; }
  .footer-icon { width: 14px; height: 14px; border: 1px solid #fff; border-radius: 2px; margin-right: 8px; }
  .keypad-wrapper { margin-top: 10px; }
  .keypad-num { display: flex; justify-content: center; }
  .col { display: flex; flex-direction: column; }
  .center-col { display: flex; flex-direction: column; margin: 0 2px; }
  .center-row { display: flex; justify-content: center; }
  .btn, .grid-btn { background: #0b6fd8; border: 2px solid #083f82; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; cursor: pointer; width: 60px; height: 34px; margin: 3px; font-size: 16px; }
  .grid-btn { font-size: 18px; }
  .keypad-qwerty { display: none; flex-direction: column; align-items: center; }
  .q-row { display: flex; justify-content: center; }
  .q-btn { width: 30px; height: 34px; margin: 1px; background: #0b6fd8; border: 2px solid #083f82; border-radius: 4px; color: #fff; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
  .q-btn.wide { width: 45px; }
  .q-btn.space { width: 96px; }
  
  .scanner-modal { display: none; position: fixed; top: 0; left: 0; width: 360px; height: 640px; background: #000; z-index: 9999; flex-direction: column; }
  .scanner-modal.active { display: flex; }
  .scanner-header { width: 360px; height: 32px; background: #0b6fd8; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; }
  .scanner-close { width: 24px; height: 24px; background: rgba(255,255,255,0.2); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; }
  .scanner-content { flex: 1; background: #000; position: relative; }
  #scanner-video { width: 100%; height: 100%; object-fit: cover; }
  .scanner-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 280px; height: 140px; border: 2px solid #0b6fd8; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); }
  .scanner-footer { width: 360px; height: 60px; background: #0b6fd8; display: flex; align-items: center; justify-content: center; }
  .scanner-cancel { background: #8B0000; border: 1px solid #5a0000; border-radius: 4px; color: #fff; font-weight: bold; font-size: 16px; padding: 10px 30px; cursor: pointer; }
</style>
</head>

<body>
  <div class="header">
    <div class="title">Scan Barcode</div>
    <div class="icons"><div class="icon"></div><div class="icon"></div><div class="icon"></div><div class="icon"></div><div class="dots"></div></div>
  </div>

  <div class="under-area">
    <button class="scan-btn" id="scanBtn">üì∑ SCAN BARCODE</button>
    
    <div class="under-header">Scan/key-in barcode</div>

    <!-- GRID -->
    <div class="grid">
      <div class="row" id="inputRow">
        <div class="cell orange input-cell" data-index="0"></div><div class="cell input-cell" data-index="1"></div><div class="cell input-cell" data-index="2"></div><div class="cell input-cell" data-index="3"></div><div class="cell input-cell" data-index="4"></div><div class="cell input-cell" data-index="5"></div><div class="cell input-cell" data-index="6"></div><div class="cell input-cell" data-index="7"></div><div class="cell input-cell" data-index="8"></div><div class="cell input-cell" data-index="9"></div><div class="cell input-cell" data-index="10"></div><div class="cell input-cell" data-index="11"></div><div class="cell input-cell" data-index="12"></div><div class="cell input-cell" data-index="13"></div><div class="cell input-cell" data-index="14"></div><div class="cell input-cell" data-index="15"></div><div class="cell input-cell" data-index="16"></div><div class="cell input-cell" data-index="17"></div><div class="cell input-cell" data-index="18"></div><div class="cell input-cell" data-index="19"></div>
      </div>
      <div class="row"><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>
      <div class="row"><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell gray"></div><div class="cell gray"></div><div class="cell gray"></div><div class="cell gray"></div><div class="cell gray"></div><div class="cell gray"></div><div class="cell gray"></div><div class="cell gray"></div><div class="cell gray"></div><div class="cell gray"></div><div class="cell gray"></div></div>
    </div>

    <div class="select-status-header">SELECT STATUS</div>

    <select class="status-select" id="statusSelect">
      <option value="">-- Select Status --</option>
      <option value="Item Booked">Item Booked</option>
      <option value="Item Bagged">Item Bagged</option>
      <option value="Item Dispatched">Item Dispatched</option>
      <option value="Item Received">Item Received</option>
      <option value="In-Transit">In-Transit</option>
      <option value="Item Received at Delivery Office">Item Received at Delivery Office</option>
      <option value="Out for Delivery">Out for Delivery</option>
      <option value="Delivered">Delivered</option>
    </select>

    <div class="gps-status" id="gpsStatus">
      <span class="gps-dot" id="gpsDot"></span>
      <span id="gpsText">Getting location details...</span>
    </div>

    <div class="label-bar">|#| LABEL ID |</div>
    <div id="statusMessage" class="status-message">Ready</div>
    
    <div class="footer">
      <div class="footer-icons"><div class="footer-icon"></div><div class="footer-icon"></div><div class="footer-icon"></div></div>
      <div id="timeDisplay"></div>
    </div>

    <!-- KEYPADS -->
    <div class="keypad-wrapper">
      <div class="keypad-num" id="keypadNum">
        <div class="col"><div class="btn key-btn" data-action="left">‚Üê</div><div class="btn key-btn" data-action="right">‚Üí</div><div class="btn key-btn" data-action="esc">ESC</div><div class="btn key-btn" data-action="toQwerty">ABC SYM</div></div>
        <div class="center-col">
          <div class="center-row"><div class="grid-btn key-btn" data-char="1">1</div><div class="grid-btn key-btn" data-char="2">2</div><div class="grid-btn key-btn" data-char="3">3</div></div>
          <div class="center-row"><div class="grid-btn key-btn" data-char="4">4</div><div class="grid-btn key-btn" data-char="5">5</div><div class="grid-btn key-btn" data-char="6">6</div></div>
          <div class="center-row"><div class="grid-btn key-btn" data-char="7">7</div><div class="grid-btn key-btn" data-char="8">8</div><div class="grid-btn key-btn" data-char="9">9</div></div>
          <div class="center-row"><div class="grid-btn key-btn" data-char="-">-</div><div class="grid-btn key-btn" data-char="0">0</div><div class="grid-btn key-btn" data-char=".">.</div></div>
        </div>
        <div class="col"><div class="btn key-btn" data-action="up">‚Üë</div><div class="btn key-btn" data-action="down">‚Üì</div><div class="btn key-btn" data-action="backspace">‚å´</div><div class="btn key-btn" data-action="enter">ENT‚Üµ</div></div>
      </div>

      <div class="keypad-qwerty" id="keypadQwerty">
        <div class="q-row"><div class="q-btn key-btn" data-char="Q">Q</div><div class="q-btn key-btn" data-char="W">W</div><div class="q-btn key-btn" data-char="E">E</div><div class="q-btn key-btn" data-char="R">R</div><div class="q-btn key-btn" data-char="T">T</div><div class="q-btn key-btn" data-char="Y">Y</div><div class="q-btn key-btn" data-char="U">U</div><div class="q-btn key-btn" data-char="I">I</div><div class="q-btn key-btn" data-char="O">O</div><div class="q-btn key-btn" data-char="P">P</div></div>
        <div class="q-row"><div class="q-btn key-btn" data-char="A">A</div><div class="q-btn key-btn" data-char="S">S</div><div class="q-btn key-btn" data-char="D">D</div><div class="q-btn key-btn" data-char="F">F</div><div class="q-btn key-btn" data-char="G">G</div><div class="q-btn key-btn" data-char="H">H</div><div class="q-btn key-btn" data-char="J">J</div><div class="q-btn key-btn" data-char="K">K</div><div class="q-btn key-btn" data-char="L">L</div></div>
        <div class="q-row"><div class="q-btn wide">‚áß</div><div class="q-btn key-btn" data-char="Z">Z</div><div class="q-btn key-btn" data-char="X">X</div><div class="q-btn key-btn" data-char="C">C</div><div class="q-btn key-btn" data-char="V">V</div><div class="q-btn key-btn" data-char="B">B</div><div class="q-btn key-btn" data-char="N">N</div><div class="q-btn key-btn" data-char="M">M</div><div class="q-btn wide">‚áß</div></div>
        <div class="q-row"><div class="q-btn wide key-btn" data-action="toNum">123</div><div class="q-btn space key-btn" data-char=" ">SPACE</div><div class="q-btn wide key-btn" data-action="backspace">‚å´</div><div class="q-btn wide key-btn" data-action="enter">‚Üµ</div></div>
      </div>
    </div>
  </div>

  <!-- SCANNER MODAL -->
  <div class="scanner-modal" id="scannerModal">
    <div class="scanner-header"><div class="scanner-title">Scan Barcode</div><div class="scanner-close" id="closeScanner">‚úï</div></div>
    <div class="scanner-content"><video id="scanner-video"></video><div class="scanner-frame"></div></div>
    <div class="scanner-footer"><div class="scanner-cancel" id="cancelScan">CANCEL</div></div>
  </div>

<script>
  // TIME UPDATE
  function updateTime() {
    var el = document.getElementById("timeDisplay");
    var now = new Date();
    var hours = now.getHours();
    var ampm = hours >= 12 ? "PM" : "AM";
    hours = hours % 12 || 12;
    var minutes = now.getMinutes() < 10 ? "0" + now.getMinutes() : now.getMinutes();
    el.textContent = (now.getMonth()+1) + "/" + now.getDate() + " " + hours + ":" + minutes + " " + ampm;
  }
  setInterval(updateTime, 1000);
  updateTime();

  // =============================================
  // LOCATION with reverse geocoding (city, state, zip)
  // =============================================
  var gpsDot = document.getElementById("gpsDot");
  var gpsText = document.getElementById("gpsText");
  var currentCityStateZip = "Acquiring location..."; // default text
  var locationDetails = {
    city: "",
    state: "",
    zip: "",
    full: "Unknown"
  };

  // Use reverse geocoding via OpenStreetMap (no API key required)
  function fetchAddressFromCoords(lat, lon) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`)
      .then(response => response.json())
      .then(data => {
        console.log("Geocoding response:", data);
        if (data && data.address) {
          const addr = data.address;
          // Extract city, state, postcode
          let city = addr.city || addr.town || addr.village || addr.hamlet || "";
          let state = addr.state || "";
          let zip = addr.postcode || "";
          
          locationDetails = { city, state, zip, full: "" };
          // Create a readable string
          let parts = [];
          if (city) parts.push(city);
          if (state) parts.push(state);
          if (zip) parts.push(zip);
          locationDetails.full = parts.join(", ") || "Unknown location";
          
          currentCityStateZip = locationDetails.full;
          gpsText.textContent = "üìç " + currentCityStateZip;
          gpsDot.className = "gps-dot active";
        } else {
          // fallback: just show coordinates
          currentCityStateZip = lat.toFixed(4) + ", " + lon.toFixed(4);
          gpsText.textContent = "üìç " + currentCityStateZip + " (city not found)";
          gpsDot.className = "gps-dot active";
        }
      })
      .catch(error => {
        console.error("Reverse geocode error:", error);
        // fallback: show lat/lon
        currentCityStateZip = lat.toFixed(4) + ", " + lon.toFixed(4);
        gpsText.textContent = "üìç " + currentCityStateZip + " (geocode unavailable)";
        gpsDot.className = "gps-dot active";
      });
  }

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          var lat = position.coords.latitude;
          var lon = position.coords.longitude;
          // First update with coordinates while we fetch address
          currentCityStateZip = lat.toFixed(4) + ", " + lon.toFixed(4);
          gpsText.textContent = "üìç " + currentCityStateZip + " (resolving address...)";
          gpsDot.className = "gps-dot active";
          
          // Now reverse geocode to get city, state, zip
          fetchAddressFromCoords(lat, lon);
        },
        function(error) {
          console.warn("GPS error:", error);
          currentCityStateZip = "GPS unavailable";
          gpsText.textContent = "‚ö†Ô∏è GPS unavailable";
          gpsDot.className = "gps-dot"; // orange dot (no active class)
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    } else {
      currentCityStateZip = "Geolocation not supported";
      gpsText.textContent = "‚ùå Geolocation not supported";
    }
  }
  getLocation();

  // GRID LOGIC
  var cells = Array.from(document.querySelectorAll(".input-cell"));
  var activeIndex = 0;
  var statusMsg = document.getElementById("statusMessage");
  var statusSelect = document.getElementById("statusSelect");

  function setActive(i) { 
    cells.forEach(c => c.classList.remove("orange")); 
    cells[i].classList.add("orange"); 
    activeIndex = i; 
  }
  
  function writeChar(ch) { 
    cells[activeIndex].textContent = ch; 
    if (activeIndex < 19) setActive(activeIndex + 1); 
  }
  
  function writeBarcode(bc) { 
    for (var i=0; i<bc.length && i<20; i++) cells[i].textContent = bc[i]; 
    setActive(0); 
  }
  
  function getBarcode() { 
    var bc = ""; 
    for (var i=0; i<20; i++) if (cells[i].textContent) bc += cells[i].textContent; else break; 
    return bc; 
  }
  
  function clearGrid() { 
    cells.forEach(c => c.textContent = ""); 
    setActive(0); 
  }
// ETA calculation rules based on status
const ETA_RULES = {
  "Item Booked": 7,
  "Item Bagged": -1,
  "Item Dispatched": -1,
  "Item Received": -1,
  "In-Transit": -1,
  "Item Received at Delivery Office": -1,
  "Out for delivery": -2,
  "Delivered": 0
};
  // =============================================
  // GOOGLE APPS SCRIPT URL (unchanged)
  // =============================================
  var GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyPuKraCIl5bkA5UR3xV8oK5QplHpjbe_uZfRM2B1OSb22S7gw0KaZ9qtiyedP0cEw/exec";
  
  function sendToGoogleSheets(barcode) {
    var status = statusSelect.value;
    if (!status) { 
      statusMsg.className = "status-message error";
      statusMsg.textContent = "Select status!"; 
      return; 
    }
    
    statusMsg.className = "status-message sending";
    statusMsg.textContent = "Saving to Google Sheets...";
    
    var now = new Date();
    var date = now.getFullYear() + "-" + 
               String(now.getMonth() + 1).padStart(2, '0') + "-" + 
               String(now.getDate()).padStart(2, '0');
    var time = String(now.getHours()).padStart(2, '0') + ":" + 
               String(now.getMinutes()).padStart(2, '0') + ":" + 
               String(now.getSeconds()).padStart(2, '0');
    
    // Use city/state/zip if available, otherwise fallback to what we have
    var locationString = locationDetails.full || currentCityStateZip;
    
    var formData = new FormData();
    formData.append("label_id", barcode);
    formData.append("barcode_type", "EAN-13");
    formData.append("status", status);
    formData.append("date", date);
    formData.append("time", time);
    formData.append("location", locationString);            // Now contains city/state/zip
    formData.append("city", locationDetails.city || "");
    formData.append("state", locationDetails.state || "");
    formData.append("zip", locationDetails.zip || "");
    formData.append("eta", date);
    formData.append("timestamp", now.toISOString());

    console.log("SENDING:", Object.fromEntries(formData));
    
    var xhr = new XMLHttpRequest();
    xhr.open("POST", GOOGLE_SCRIPT_URL, true);
    
    xhr.onload = function() {
      console.log("RESPONSE:", xhr.responseText);
      try {
        var response = JSON.parse(xhr.responseText);
        if (response.success) {
          statusMsg.className = "status-message success";
          statusMsg.textContent = "‚úì SAVED TO GOOGLE SHEETS!";
          alert("‚úÖ SUCCESS!\nBarcode: " + barcode + "\nStatus: " + status + "\nLocation: " + locationString);
          clearGrid();
        } else {
          throw new Error(response.error || "Unknown error");
        }
      } catch(e) {
        statusMsg.className = "status-message error";
        statusMsg.textContent = "‚úó Error: " + e.message;
        alert("‚ùå ERROR:\n" + e.message);
      }
    };
    
    xhr.onerror = function() {
      statusMsg.className = "status-message error";
      statusMsg.textContent = "‚úó Network error";
      alert("‚ùå NETWORK ERROR\nCheck that your Google Script is deployed with 'Anyone' access");
    };
    
    xhr.send(formData);
  }

  function doEnter() { 
    var bc = getBarcode(); 
    if (bc) {
      // Refresh location before sending
      getLocation();
      setTimeout(function() { sendToGoogleSheets(bc); }, 1500); // extra time for geocode
    } else {
      statusMsg.className = "status-message error";
      statusMsg.textContent = "No barcode entered";
    }
  }
  
  function doEsc() { 
    clearGrid(); 
    statusMsg.className = "status-message";
    statusMsg.textContent = "Ready"; 
  }

  // SCANNER
  var scannerModal = document.getElementById("scannerModal");
  document.getElementById("scanBtn").onclick = function() { 
    scannerModal.classList.add("active"); 
    startScanner(); 
  };
  
  function closeScanner() { 
    if (codeReader) codeReader.reset(); 
    scannerModal.classList.remove("active"); 
  }
  
  document.getElementById("closeScanner").onclick = closeScanner;
  document.getElementById("cancelScan").onclick = closeScanner;
  
  var codeReader;
  function startScanner() {
    try {
      codeReader = new ZXing.BrowserMultiFormatReader();
      codeReader.decodeFromVideoDevice(null, document.getElementById("scanner-video"), function(result) {
        if (result) {
          writeBarcode(result.text);
          closeScanner();
        }
      });
    } catch(e) { alert("Camera error: " + e.message); }
  }

  // KEYPAD
  document.querySelectorAll(".key-btn").forEach(btn => {
    btn.onclick = function() {
      var char = this.dataset.char;
      var action = this.dataset.action;
      if (char) writeChar(char);
      else if (action === "left" && activeIndex>0) setActive(activeIndex-1);
      else if (action === "right" && activeIndex<19) setActive(activeIndex+1);
      else if (action === "up" && activeIndex>19) setActive(activeIndex-20);
      else if (action === "down" && activeIndex<180) setActive(activeIndex+20);
      else if (action === "backspace") { 
        if (cells[activeIndex].textContent) cells[activeIndex].textContent = "";
        else if (activeIndex>0) { setActive(activeIndex-1); cells[activeIndex].textContent = ""; }
      }
      else if (action === "enter") doEnter();
      else if (action === "esc") doEsc();
      else if (action === "toQwerty") {
        document.getElementById("keypadNum").style.display = "none";
        document.getElementById("keypadQwerty").style.display = "flex";
      }
      else if (action === "toNum") {
        document.getElementById("keypadNum").style.display = "flex";
        document.getElementById("keypadQwerty").style.display = "none";
      }
    };
  });

  setActive(0);
</script>
</body>
</html>
