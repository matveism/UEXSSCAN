<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>parcel flow ‚Ä¢ live track</title>
  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #faf9f6;
      --surface: #ffffff;
      --fg: #1e1e2f;
      --primary: #1e3a5f;
      --primary-light: #2b4c7c;
      --primary-fg: #ffffff;
      --muted: #5a6b7a;
      --border: #d9e0e8;
      --accent-soft: #ebf0f7;
      --green: #2e6b4b;
      --amber: #b45b1c;
      --dot: #1e3a5f;
      --line: #bac8d9;
      --shadow-sm: 0 6px 12px rgba(0,0,0,0.02), 0 2px 6px rgba(0,0,0,0.03);
      --shadow-focus: 0 0 0 3px rgba(30,58,95,0.15);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.5;
    }

    header {
      background: var(--primary);
      color: var(--primary-fg);
      padding: 20px 24px;
      box-shadow: inset 0 -1px 0 rgba(255,255,255,0.1);
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .header-inner svg {
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .header-inner h1 {
      font-size: 1.6rem;
      font-weight: 450;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px 50px;
    }

    .input-wrap {
      max-width: 720px;
      margin: 0 auto 30px;
    }

    .input-wrap label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: 8px;
      letter-spacing: 0.3px;
    }

    .input-row {
      display: flex;
      box-shadow: var(--shadow-sm);
      border-radius: 16px;
      overflow: hidden;
      background: var(--surface);
      border: 1px solid var(--border);
      transition: box-shadow 0.15s;
    }

    .input-row:focus-within {
      box-shadow: var(--shadow-focus), var(--shadow-sm);
      border-color: var(--primary);
    }

    .input-row input {
      flex: 1;
      padding: 16px 20px;
      border: none;
      font-size: 1.2rem;
      font-family: 'SF Mono', 'Fira Code', monospace;
      background: transparent;
      outline: none;
      color: var(--fg);
    }

    .input-row input::placeholder {
      color: #a7b8c9;
      font-weight: 300;
      font-size: 1rem;
    }

    .input-row button {
      padding: 0 28px;
      background: var(--primary);
      color: var(--primary-fg);
      font-weight: 600;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.1s;
      border-left: 1px solid rgba(255,255,255,0.15);
    }

    .input-row button:hover {
      background: var(--primary-light);
    }

    .input-row button:active {
      transform: scale(0.98);
    }

    .tracking-dashboard {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 28px;
      margin-top: 20px;
    }

    @media (max-width: 850px) {
      .tracking-dashboard {
        grid-template-columns: 1fr;
      }
    }

    .left-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
    }

    .tracking-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .tracking-num {
      font-size: 1.8rem;
      font-weight: 550;
      font-family: 'SF Mono', monospace;
      margin-bottom: 10px;
      word-break: break-word;
      color: var(--primary);
    }

    .action-btns {
      display: flex;
      gap: 24px;
      font-size: 0.9rem;
      margin-bottom: 20px;
      border-bottom: 1px dashed var(--border);
      padding-bottom: 12px;
    }

    .action-btns button {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-weight: 500;
      padding: 4px 0;
      border-bottom: 1px solid transparent;
    }

    .action-btns button:hover {
      border-bottom-color: var(--primary);
    }

    .status-badge {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .status-value {
      font-size: 2.0rem;
      font-weight: 480;
      color: var(--primary);
      margin-bottom: 18px;
    }

    .status-value.delivered {
      color: var(--green);
    }

    .eta-box {
      background: var(--accent-soft);
      border-radius: 20px;
      padding: 16px 20px;
      margin: 20px 0;
    }

    .eta-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .eta-row {
      display: flex;
      align-items: baseline;
      gap: 20px;
      flex-wrap: wrap;
    }

    .eta-date {
      font-size: 2.2rem;
      font-weight: 600;
      color: var(--primary);
      line-height: 1;
    }

    .eta-month {
      font-size: 1rem;
      color: var(--muted);
    }

    .eta-time {
      font-size: 1.6rem;
      font-weight: 500;
      color: var(--primary);
    }

    .map-container {
      margin-top: 28px;
      border-radius: 24px;
      overflow: hidden;
      border: 1px solid var(--border);
      height: 350px;
      background: #e9ecf0;
      position: relative;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    #liveMap {
      height: 100%;
      width: 100%;
      z-index: 5;
    }

    .map-note {
      font-size: 0.9rem;
      color: var(--primary);
      margin-top: 10px;
      text-align: center;
      font-weight: 600;
      background: var(--accent-soft);
      padding: 8px 16px;
      border-radius: 40px;
      display: inline-block;
      width: auto;
      margin-left: auto;
      margin-right: auto;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px 10px;
      border-top: 1px solid var(--border);
      padding-top: 20px;
      margin-top: 16px;
      font-size: 0.95rem;
    }

    .detail-grid .label {
      color: var(--muted);
    }

    .detail-grid .val {
      font-weight: 600;
      word-break: break-word;
    }

    .timeline-title {
      font-size: 1.5rem;
      font-weight: 440;
      color: var(--primary);
      margin-bottom: 24px;
    }

    .timeline-row {
      display: flex;
      gap: 18px;
      padding-bottom: 26px;
      position: relative;
    }

    .timeline-col {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--dot);
      margin-top: 6px;
      border: 2px solid white;
      box-shadow: 0 0 0 1px var(--line);
    }

    .dot.delivered {
      background: var(--green);
      width: 20px;
      height: 20px;
      margin-top: 3px;
      box-shadow: 0 0 0 1px var(--green);
    }

    .dot.out-for-delivery {
      background: var(--amber);
      box-shadow: 0 0 0 1px var(--amber);
    }

    .connector {
      width: 2px;
      flex: 1;
      background: var(--line);
      margin-top: 4px;
      min-height: 24px;
    }

    .event-status {
      font-weight: 650;
      font-size: 1.1rem;
    }

    .event-status.delivered { color: var(--green); }
    .event-status.out-for-delivery { color: var(--amber); }

    .event-detail {
      font-size: 0.95rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .show-history {
      margin-top: 24px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 60px;
      padding: 12px 20px;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      text-align: center;
    }

    .show-history:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .loading, .error-msg, .empty-state {
      text-align: center;
      margin-top: 50px;
    }
    .spinner {
      width: 38px;
      height: 38px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.9s infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-msg { background: #fdeded; color: #b33f3f; border-radius: 40px; padding: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
    .empty-state svg { stroke: var(--muted); opacity: 0.5; margin-bottom: 12px; }
    
    .custom-marker {
      background: none;
      border: none;
      font-size: 40px;
      line-height: 1;
      text-align: center;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
    }
    
    .location-highlight {
      background: var(--primary);
      color: white;
      padding: 4px 12px;
      border-radius: 40px;
      font-size: 0.9rem;
      display: inline-block;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
        <path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
        <polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/>
      </svg>
      <h1>FLOW TRACK ‚Ä¢ LIVE</h1>
    </div>
  </header>

  <main>
    <div class="input-wrap">
      <label>üîé tracking number</label>
      <div class="input-row">
        <input type="text" id="trackInput" placeholder="e.g. 1919" value="1919" />
        <button id="trackBtn">track ‚Üí</button>
      </div>
    </div>

    <div id="loadingState" class="loading" style="display:none;">
      <div class="spinner"></div> contacting depot...
    </div>
    <div id="errorState" class="error-msg" style="display:none;"></div>
    <div id="emptyState" class="empty-state">
      <svg width="72" height="72" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
        <polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/>
      </svg>
      <p>enter a tracking number to view live location & status</p>
    </div>

    <div id="dashboard" class="tracking-dashboard" style="display:none;">
      <div class="left-panel" id="leftPanel"></div>
      <div id="timelinePanel"></div>
    </div>
  </main>

  <script>
    (function() {
      // Your exact CSV URL
      const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRcCfqR0Yn3zjCBHYPT0gcPNcJjQ8QwgqsIyTbySG99R3l8VPsjotxwhasGL1yh6lLToq3G0p6AOZZR/pub?gid=0&single=true&output=csv";

      // ETA rules
      const ETA_RULES = {
        "Item Booked": 5, "Item Bagged": 4, "Item Dispatched": 3,
        "Item Received": 3, "In-Transit": 2, "Item Received at Delivery Office": 1,
        "Out for Delivery": 0, "Delivered": 0
      };

      // Global variables
      let allScans = [];
      let showFullHistory = false;
      let map = null;
      let marker = null;
      let currentTrackingNumber = '';

      // ----- PARSE CSV EXACTLY -----
      function parseCSV(csvText) {
        const lines = csvText.split('\n').filter(l => l.trim() !== '');
        if (!lines.length) return [];
        
        // Get headers exactly as they appear
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        console.log("CSV Headers:", headers); // Debug
        
        return lines.slice(1).map(line => {
          // Handle quoted values properly
          const values = [];
          let inQuotes = false;
          let currentValue = '';
          
          for (let char of line) {
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              values.push(currentValue);
              currentValue = '';
            } else {
              currentValue += char;
            }
          }
          values.push(currentValue); // Add the last value
          
          // Clean up each value
          const cleanValues = values.map(v => v.trim().replace(/"/g, ''));
          
          const rec = {};
          headers.forEach((h, idx) => {
            const val = cleanValues[idx] || '';
            
            // Map exactly to your table columns
            if (h === 'label_id' || h === 'labelid' || h.includes('label')) {
              rec.label_id = val;
            }
            else if (h === 'barcode_type' || h.includes('barcode')) {
              rec.barcode_type = val;
            }
            else if (h === 'status') {
              rec.status = val;
            }
            else if (h === 'date') {
              rec.date = val;
            }
            else if (h === 'time') {
              rec.time = val;
            }
            else if (h === 'location') {
              // THIS IS THE EXACT LOCATION FROM YOUR TABLE
              rec.location = val; // "Silverton, Oregon, 97381"
              console.log(`Found location: "${val}"`); // Debug
            }
            else if (h === 'eta') {
              rec.eta = val;
            }
            else if (h === 'timestamp') {
              rec.timestamp = val;
            }
          });
          
          return rec;
        });
      }

      // ----- GEOCODE THE LOCATION STRING TO COORDINATES -----
      async function geocodeLocation(locationStr) {
        if (!locationStr) return null;
        
        console.log("Geocoding:", locationStr); // Debug
        
        try {
          // Use OpenStreetMap Nominatim
          const encodedLocation = encodeURIComponent(locationStr + ", USA");
          const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedLocation}&limit=1`, {
            headers: {
              'User-Agent': 'ParcelFlow/1.0'
            }
          });
          
          const data = await response.json();
          
          if (data && data.length > 0) {
            const coords = {
              lat: parseFloat(data[0].lat),
              lng: parseFloat(data[0].lon)
            };
            console.log("Geocoded to:", coords); // Debug
            return coords;
          }
        } catch (error) {
          console.error("Geocoding error:", error);
        }
        
        return null;
      }

      // ----- CALCULATE ETA -----
      function calculateETA(scans) {
        if (!scans.length) return null;
        
        const latest = scans[0];
        const status = latest.status || '';
        
        if (status.toLowerCase().includes('delivered')) return null;
        
        // Use the eta from CSV if available
        if (latest.eta) {
          return new Date(latest.eta);
        }
        
        // Default to tomorrow
        const eta = new Date();
        eta.setDate(eta.getDate() + 1);
        return eta;
      }

      // ----- RENDER LEFT PANEL WITH MAP -----
      async function renderLeftPanel(trackingNumber, latest, etaDate, isDelivered) {
        const isOutForDelivery = latest.status.toLowerCase().includes('out for delivery');
        
        // Get coordinates for the location from CSV
        let coords = null;
        if (latest.location) {
          coords = await geocodeLocation(latest.location);
        }
        
        // ETA HTML
        let etaHtml = '';
        if (etaDate && !isDelivered) {
          const weekday = etaDate.toLocaleDateString('en-US', { weekday: 'long' });
          const day = etaDate.getDate();
          const month = etaDate.toLocaleDateString('en-US', { month: 'long' });
          const year = etaDate.getFullYear();
          etaHtml = `
            <div class="eta-box">
              <div class="eta-label">expected delivery</div>
              <div class="eta-row">
                <span class="eta-date">${day}</span>
                <span class="eta-month">${month} ${year}</span>
                <span class="eta-time">~9:00 PM</span>
              </div>
              <div style="margin-top:6px;">${weekday}</div>
            </div>
          `;
        } else if (isDelivered) {
          etaHtml = `<div class="eta-box"><span class="status-value delivered">‚úì Delivered</span></div>`;
        }

        // Map container
        const mapHtml = `
          <div class="map-container" id="mapContainer">
            <div id="liveMap"></div>
          </div>
          <div class="map-note">
            üìç Exact location from courier: <strong>${latest.location}</strong>
          </div>
        `;

        document.getElementById('leftPanel').innerHTML = `
          <p class="tracking-label">tracking number</p>
          <p class="tracking-num">${trackingNumber}</p>
          <div class="action-btns">
            <button onclick="navigator.clipboard.writeText('${trackingNumber}')">üìã copy</button>
            <button onclick="alert('Parcel #${trackingNumber} is being watched')">‚≠ê watch</button>
          </div>
          <div class="status-badge">latest status</div>
          <div class="status-value ${isDelivered ? 'delivered' : ''}">${latest.status}</div>
          ${etaHtml}
          ${mapHtml}
          <div class="detail-grid">
            <div><span class="label">type: </span><span class="val">${latest.barcode_type || 'EAN-13'}</span></div>
            <div><span class="label">location: </span><span class="val"><span class="location-highlight">${latest.location}</span></span></div>
            <div><span class="label">date: </span><span class="val">${latest.date || ''}</span></div>
            <div><span class="label">time: </span><span class="val">${latest.time || ''}</span></div>
            <div><span class="label">eta: </span><span class="val">${latest.eta || ''}</span></div>
          </div>
        `;

        // Initialize map after element exists
        setTimeout(() => {
          const mapDiv = document.getElementById('liveMap');
          if (!mapDiv) return;

          if (map) { 
            map.remove(); 
            map = null; 
            marker = null; 
          }

          if (coords) {
            // Create map with ZOOM LEVEL 15 for street level
            map = L.map('liveMap').setView([coords.lat, coords.lng], 15);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            
            // Create custom icon based on status
            let icon;
            if (isDelivered) {
              icon = L.divIcon({ 
                html: 'üìç', 
                className: 'custom-marker',
                iconSize: [40, 40],
                popupAnchor: [0, -20]
              });
            } else if (isOutForDelivery) {
              icon = L.divIcon({ 
                html: 'üöö', 
                className: 'custom-marker',
                iconSize: [44, 44],
                popupAnchor: [0, -22]
              });
            } else {
              icon = L.divIcon({ 
                html: 'üì¶', 
                className: 'custom-marker',
                iconSize: [40, 40],
                popupAnchor: [0, -20]
              });
            }
            
            marker = L.marker([coords.lat, coords.lng], { icon: icon }).addTo(map);
            
            // Add popup with EXACT location from CSV
            marker.bindPopup(`
              <b>${latest.status}</b><br>
              üìç ${latest.location}<br>
              üïí ${latest.date} ${latest.time}
            `).openPopup();
            
          } else {
            // Fallback to a default view if geocoding fails
            map = L.map('liveMap').setView([39.8283, -98.5795], 4);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            L.marker([39.8283, -98.5795]).addTo(map).bindPopup('Location: ' + latest.location);
          }
        }, 100);
      }

      // ----- RENDER TIMELINE -----
      function renderTimeline() {
        const events = showFullHistory ? allScans : allScans.slice(0, 3);
        let html = '<h3 class="timeline-title">tracking history</h3><div>';

        events.forEach((ev, i) => {
          const s = ev.status.toLowerCase();
          const isDelivered = s.includes('delivered');
          const isOFD = s.includes('out for delivery');

          let dotClass = 'dot';
          if (isDelivered) dotClass = 'dot delivered';
          else if (isOFD) dotClass = 'dot out-for-delivery';

          const connector = (i < events.length - 1) ? '<div class="connector"></div>' : '';

          let dateStr = '';
          if (ev.date) {
            dateStr = ev.date;
            if (ev.time) dateStr += ' at ' + ev.time;
          }

          html += `
            <div class="timeline-row">
              <div class="timeline-col">
                <div class="${dotClass}"></div>${connector}
              </div>
              <div>
                <p class="event-status ${isDelivered ? 'delivered' : ''}">${ev.status}</p>
                ${ev.location ? `<p class="event-detail">üìç ${ev.location}</p>` : ''}
                ${dateStr ? `<p class="event-detail">üïí ${dateStr}</p>` : ''}
              </div>
            </div>
          `;
        });

        html += '</div>';
        if (allScans.length > 3) {
          html += `<button class="show-history" onclick="window.toggleHistory()">${showFullHistory ? '‚àí hide full history' : '+ show full history (' + allScans.length + ' events)'}</button>`;
        }
        document.getElementById('timelinePanel').innerHTML = html;
      }

      window.toggleHistory = function() {
        showFullHistory = !showFullHistory;
        renderTimeline();
      };

      // ----- MAIN TRACK HANDLER -----
      async function handleTrack() {
        const input = document.getElementById('trackInput').value.trim();
        if (!input) return;

        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('errorState').style.display = 'none';
        document.getElementById('dashboard').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';

        try {
          // Fetch CSV
          const response = await fetch(CSV_URL);
          if (!response.ok) throw new Error('Failed to fetch tracking data');
          
          const csvText = await response.text();
          console.log("CSV Data:", csvText.substring(0, 200)); // Debug first 200 chars
          
          const records = parseCSV(csvText);
          console.log("Parsed records:", records); // Debug all records
          
          // Filter by tracking number
          const filtered = records.filter(r => r.label_id && r.label_id.trim() === input.trim());
          console.log("Filtered for", input, ":", filtered); // Debug filtered
          
          if (filtered.length === 0) {
            document.getElementById('errorState').textContent = `‚úó No tracking data found for "${input}"`;
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('loadingState').style.display = 'none';
            return;
          }

          // Sort by date (most recent first)
          allScans = filtered.sort((a, b) => {
            if (a.date && b.date) {
              return b.date.localeCompare(a.date);
            }
            return 0;
          });
          
          currentTrackingNumber = input;
          showFullHistory = false;

          const latest = allScans[0];
          const eta = calculateETA(allScans);
          const isDelivered = latest.status.toLowerCase().includes('delivered');

          // Show dashboard
          document.getElementById('dashboard').style.display = 'grid';
          
          // Render panels
          await renderLeftPanel(input, latest, eta, isDelivered);
          renderTimeline();

        } catch (error) {
          console.error("Error:", error);
          document.getElementById('errorState').textContent = 'Error: ' + error.message;
          document.getElementById('errorState').style.display = 'block';
        } finally {
          document.getElementById('loadingState').style.display = 'none';
        }
      }

      // Event listeners
      document.getElementById('trackBtn').addEventListener('click', handleTrack);
      document.getElementById('trackInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleTrack();
      });

      // Auto-load on page load
      window.addEventListener('load', () => {
        setTimeout(() => {
          handleTrack();
        }, 500);
      });

      // Initial empty state
      document.getElementById('emptyState').style.display = 'block';
    })();
  </script>
</body>
</html>
