<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>parcel flow ‚Ä¢ track</title>
  <meta name="description" content="minimal, independent package tracker" />
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #faf9f6;
      --surface: #ffffff;
      --fg: #1e1e2f;
      --primary: #1e3a5f;          /* deep navy ‚Äì no brand conflict */
      --primary-light: #2b4c7c;
      --primary-fg: #ffffff;
      --muted: #5a6b7a;
      --border: #d9e0e8;
      --accent-soft: #ebf0f7;
      --green: #2e6b4b;
      --amber: #b45b1c;
      --dot: #1e3a5f;
      --line: #bac8d9;
      --shadow-sm: 0 6px 12px rgba(0,0,0,0.02), 0 2px 6px rgba(0,0,0,0.03);
      --shadow-focus: 0 0 0 3px rgba(30,58,95,0.15);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.5;
    }

    /* simple reset for header */
    header {
      background: var(--primary);
      color: var(--primary-fg);
      padding: 20px 24px;
      box-shadow: inset 0 -1px 0 rgba(255,255,255,0.1);
    }

    .header-inner {
      max-width: 1024px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .header-inner svg {
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .header-inner h1 {
      font-size: 1.6rem;
      font-weight: 450;
      letter-spacing: 2px;
      word-spacing: 2px;
      text-transform: uppercase;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    main {
      max-width: 1024px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    /* tracking input ‚Äì minimal, no logos */
    .input-wrap {
      max-width: 640px;
      margin: 0 auto 20px;
    }

    .input-wrap label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: 8px;
      letter-spacing: 0.3px;
    }

    .input-row {
      display: flex;
      box-shadow: var(--shadow-sm);
      border-radius: 16px;
      overflow: hidden;
      background: var(--surface);
      border: 1px solid var(--border);
      transition: box-shadow 0.15s;
    }

    .input-row:focus-within {
      box-shadow: var(--shadow-focus), var(--shadow-sm);
      border-color: var(--primary);
    }

    .input-row input {
      flex: 1;
      padding: 16px 20px;
      border: none;
      font-size: 1.2rem;
      font-family: 'SF Mono', 'Fira Code', monospace;
      background: transparent;
      outline: none;
      color: var(--fg);
    }

    .input-row input::placeholder {
      color: #a7b8c9;
      font-weight: 300;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
    }

    .input-row button {
      padding: 0 28px;
      background: var(--primary);
      color: var(--primary-fg);
      font-weight: 600;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.1s;
      letter-spacing: 0.5px;
      border-left: 1px solid rgba(255,255,255,0.15);
    }

    .input-row button:hover {
      background: var(--primary-light);
    }

    .input-row button:active {
      transform: scale(0.98);
    }

    /* grid ‚Äì original asymmetry kept */
    .results-grid {
      margin-top: 40px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
    }

    @media (max-width: 700px) {
      .results-grid { grid-template-columns: 1fr; }
    }

    /* status card ‚Äì pure layout, no ornament */
    .tracking-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .tracking-num {
      font-size: 2rem;
      font-weight: 550;
      font-family: 'SF Mono', 'Fira Code', monospace;
      margin-bottom: 8px;
      word-break: break-word;
      color: var(--primary);
    }

    .action-btns {
      display: flex;
      gap: 20px;
      font-size: 0.9rem;
      margin-bottom: 28px;
      border-bottom: 1px dashed var(--border);
      padding-bottom: 16px;
    }

    .action-btns button {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-weight: 500;
      padding: 4px 0;
      border-bottom: 1px solid transparent;
      transition: border-color 0.1s;
    }

    .action-btns button:hover {
      border-bottom-color: var(--primary);
    }

    .status-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 28px;
      box-shadow: var(--shadow-sm);
    }

    .status-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .status-value {
      font-size: 1.8rem;
      font-weight: 480;
      color: var(--primary);
      margin-bottom: 24px;
      line-height: 1.2;
    }

    .status-value.delivered {
      color: var(--green);
    }

    .eta-section {
      margin-bottom: 28px;
      background: var(--accent-soft);
      padding: 18px 20px;
      border-radius: 20px;
    }

    .eta-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    .eta-display {
      display: flex;
      align-items: flex-end;
      gap: 30px;
      flex-wrap: wrap;
    }

    .eta-weekday {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary);
      text-transform: uppercase;
    }

    .eta-day {
      font-size: 3.2rem;
      font-weight: 700;
      color: var(--primary);
      line-height: 1;
    }

    .eta-month-year p {
      font-size: 0.95rem;
      color: var(--muted);
      line-height: 1.3;
    }

    .eta-by {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .eta-time {
      font-size: 1.6rem;
      font-weight: 600;
      color: var(--primary);
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px 12px;
      font-size: 1rem;
      border-top: 1px solid var(--border);
      padding-top: 20px;
    }

    .detail-grid .label {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .detail-grid .val {
      font-weight: 600;
      word-break: break-word;
    }

    /* timeline ‚Äì no brand icons, plain circles */
    .timeline-title {
      font-size: 1.5rem;
      font-weight: 440;
      color: var(--primary);
      margin-bottom: 24px;
      letter-spacing: -0.01em;
    }

    .timeline-row {
      display: flex;
      gap: 18px;
      padding-bottom: 26px;
      position: relative;
    }

    .timeline-row:last-child {
      padding-bottom: 0;
    }

    .timeline-col {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--dot);
      margin-top: 6px;
      flex-shrink: 0;
      border: 2px solid white;
      box-shadow: 0 0 0 1px var(--line);
    }

    .dot.delivered {
      background: var(--green);
      width: 20px;
      height: 20px;
      margin-top: 3px;
      border: 2px solid white;
      box-shadow: 0 0 0 1px var(--green);
    }

    .dot.out-for-delivery {
      background: var(--amber);
      border: 2px solid white;
      box-shadow: 0 0 0 1px var(--amber);
    }

    .connector {
      width: 2px;
      flex: 1;
      background: var(--line);
      margin-top: 4px;
      min-height: 24px;
    }

    .event-status {
      font-weight: 650;
      font-size: 1.1rem;
    }

    .event-status.delivered {
      color: var(--green);
    }

    .event-detail {
      font-size: 0.95rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .show-history {
      margin-top: 24px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 60px;
      padding: 12px 20px;
      color: var(--primary);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.1s;
      width: 100%;
      text-align: center;
    }

    .show-history:hover {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    /* loading / empty / error ‚Äì plain */
    .loading {
      margin-top: 48px;
      text-align: center;
      color: var(--muted);
    }

    .spinner {
      width: 38px;
      height: 38px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.9s cubic-bezier(0.4, 0.0, 0.2, 1) infinite;
      margin: 0 auto 12px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .error-msg {
      margin-top: 40px;
      max-width: 640px;
      margin-left: auto;
      margin-right: auto;
      background: #fdeded;
      border: 1px solid #e0b3b3;
      color: #b33f3f;
      border-radius: 40px;
      padding: 20px;
      text-align: center;
      font-weight: 500;
    }

    .empty-state {
      margin-top: 80px;
      text-align: center;
      color: var(--muted);
      opacity: 0.7;
    }

    .empty-state svg {
      margin: 0 auto 16px;
      stroke: var(--muted);
      opacity: 0.4;
    }

    .empty-state p {
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <!-- abstract parcel icon, generic enough -->
      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M16.5 9.4 7.55 4.24"/>
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
        <polyline points="3.29 7 12 12 20.71 7"/>
        <line x1="12" x2="12" y1="22" y2="12"/>
      </svg>
      <h1>FLOW TRACK</h1>
    </div>
  </header>

  <main>
    <div class="input-wrap">
      <label>üîé tracking number</label>
      <div class="input-row">
        <input type="text" id="trackInput" placeholder="e.g. 1Z999AA10123456784" />
        <button id="trackBtn">track ‚Üí</button>
      </div>
    </div>

    <div id="loadingState" class="loading" style="display:none;">
      <div class="spinner"></div>
      contacting depot...
    </div>

    <div id="errorState" class="error-msg" style="display:none;"></div>

    <div id="emptyState" class="empty-state">
      <svg xmlns="http://www.w3.org/2000/svg" width="72" height="72" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
        <polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/>
      </svg>
      <p>enter a tracking number to view status</p>
    </div>

    <div id="resultsArea" class="results-grid" style="display:none;">
      <div id="statusPanel"></div>
      <div id="timelinePanel"></div>
    </div>
  </main>

  <script>
    (function() {
      // ----- configuration (identical functionality, no copyrighted design) -----
      const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRcCfqR0Yn3zjCBHYPT0gcPNcJjQ8QwgqsIyTbySG99R3l8VPsjotxwhasGL1yh6lLToq3G0p6AOZZR/pub?gid=0&single=true&output=csv";

      const ETA_RULES = {
        "Item Booked": 7,
        "Item Bagged": -1,
        "Item Dispatched": -1,
        "Item Received": -1,
        "In-Transit": -1,
        "Item Received at Delivery Office": -1,
        "Out for delivery": -2,
        "Delivered": 0
      };

      // simple location mapping (no brand references)
      const CITY_DATABASE = {
        "40.7128,-74.0060": "New York, NY 10001",
        "34.0522,-118.2437": "Los Angeles, CA 90001",
        "41.8781,-87.6298": "Chicago, IL 60601",
        "29.7604,-95.3698": "Houston, TX 77001",
        "39.9526,-75.1652": "Philadelphia, PA 19101",
        "33.4484,-112.0740": "Phoenix, AZ 85001",
        "44.9907,-93.2753": "Minneapolis, MN 55408",
        "44.990713,-93.275276": "Minneapolis, MN 55408",
        "37.7749,-122.4194": "San Francisco, CA 94101",
        "47.6062,-122.3321": "Seattle, WA 98101"
      };

      // ----- helper functions (same logic, clean) -----
      function extractCoordinates(locStr) {
        if (!locStr) return null;
        const str = locStr.trim();
        const commaPattern = /^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/;
        const spacePattern = /^(-?\d+\.?\d*)\s+(-?\d+\.?\d*)$/;
        const dmsPattern = /(-?\d+\.?\d*)[¬∞\s]*([NS])?\s*[,/\s]+\s*(-?\d+\.?\d*)[¬∞\s]*([EW])?/i;

        let m = str.match(commaPattern);
        if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
        m = str.match(spacePattern);
        if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
        m = str.match(dmsPattern);
        if (m) {
          let lat = parseFloat(m[1]), lng = parseFloat(m[3]);
          if (m[2] && m[2].toUpperCase() === 'S') lat = -Math.abs(lat);
          if (m[4] && m[4].toUpperCase() === 'W') lng = -Math.abs(lng);
          return { lat, lng };
        }
        return null;
      }

      function convertToLocation(locationStr) {
        if (!locationStr) return null;
        if (/[a-zA-Z]/.test(locationStr)) return locationStr;
        const coords = extractCoordinates(locationStr);
        if (!coords) return locationStr;

        const lat = coords.lat.toFixed(4), lng = coords.lng.toFixed(4);
        const exactKey = `${lat},${lng}`;
        if (CITY_DATABASE[exactKey]) return CITY_DATABASE[exactKey];

        const roundedKey = `${parseFloat(lat).toFixed(3)},${parseFloat(lng).toFixed(3)}`;
        if (CITY_DATABASE[roundedKey]) return CITY_DATABASE[roundedKey];

        for (const [key, val] of Object.entries(CITY_DATABASE)) {
          const [dbLat, dbLng] = key.split(',').map(Number);
          const dist = Math.hypot(dbLat - coords.lat, dbLng - coords.lng);
          if (dist < 0.5) return val;
        }
        return `${coords.lat.toFixed(4)}, ${coords.lng.toFixed(4)} (approx)`;
      }

      function createTimestamp(dateStr, timeStr) {
        if (!dateStr) return null;
        const cleanDate = dateStr.replace(/(\d+)(st|nd|rd|th)/g, '$1');
        let dateTimeStr = cleanDate;
        if (timeStr && timeStr !== "NULL" && timeStr !== "") dateTimeStr = cleanDate + ' ' + timeStr;
        const ts = new Date(dateTimeStr);
        return isNaN(ts) ? null : ts;
      }

      function parseCSV(csvText) {
        const lines = csvText.split('\n').filter(l => l.trim() !== '');
        if (lines.length === 0) return [];
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
        return lines.slice(1).map(line => {
          const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
          const record = {};
          headers.forEach((h, idx) => {
            const val = values[idx] || '';
            if (h === 'label_id') record.label_id = val;
            else if (h === 'barcode_type') record.barcode_type = val;
            else if (h === 'status') record.status = val;
            else if (h === 'date') record.date = val;
            else if (h === 'time') record.time = val;
            else if (h === 'location') {
              record.raw_location = val;
              record.location = convertToLocation(val);
            }
            else if (h === 'eta') record.eta = val;
          });
          record.timestamp = createTimestamp(record.date, record.time);
          return record;
        });
      }

      function calculateETA(scans) {
        if (!scans.length) return null;
        const sorted = [...scans].filter(s => s.timestamp).sort((a,b) => a.timestamp - b.timestamp);
        if (sorted.length === 0) return null;
        const baseDate = sorted[0].timestamp;
        const latest = scans.filter(s => s.timestamp).sort((a,b) => b.timestamp - a.timestamp)[0] || scans[0];
        const latestStatus = latest.status || '';

        let daysToAdd = 0;
        for (const [rule, days] of Object.entries(ETA_RULES)) {
          if (latestStatus.toLowerCase().includes(rule.toLowerCase())) {
            daysToAdd = days;
            break;
          }
        }
        return new Date(baseDate.getTime() + daysToAdd * 86400000);
      }

      // ----- state and render -----
      let allScans = [];
      let showFullHistory = false;

      async function handleTrack() {
        const input = document.getElementById('trackInput').value.trim();
        if (!input) return;

        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('errorState').style.display = 'none';
        document.getElementById('resultsArea').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        showFullHistory = false;

        try {
          const resp = await fetch(CSV_URL);
          if (!resp.ok) throw new Error('network issue');
          const csv = await resp.text();
          const records = parseCSV(csv);
          const filtered = records.filter(r => r.label_id && r.label_id.toLowerCase() === input.toLowerCase());

          if (filtered.length === 0) {
            document.getElementById('errorState').textContent = `‚úó no shipment found for "${input}"`;
            document.getElementById('errorState').style.display = 'block';
            return;
          }

          const valid = filtered.filter(r => r.timestamp).sort((a,b) => b.timestamp - a.timestamp);
          allScans = valid.length ? valid : filtered;
          renderResults(input);
        } catch (err) {
          document.getElementById('errorState').textContent = err.message || 'failed to load tracking';
          document.getElementById('errorState').style.display = 'block';
        } finally {
          document.getElementById('loadingState').style.display = 'none';
        }
      }

      function renderResults(trackingNumber) {
        const latest = allScans[0];
        const eta = calculateETA(allScans);
        const isDelivered = latest.status.toLowerCase().includes('delivered');

        let etaHTML = '';
        if (eta && !isNaN(eta) && !isDelivered) {
          const weekday = eta.toLocaleDateString('en-US', { weekday: 'long' });
          const day = eta.getDate();
          const month = eta.toLocaleDateString('en-US', { month: 'long' });
          const year = eta.getFullYear();
          etaHTML = `
            <div class="eta-section">
              <p class="eta-label">expected delivery</p>
              <div class="eta-display">
                <div>
                  <p class="eta-weekday">${weekday}</p>
                  <div style="display:flex; align-items:baseline; gap:8px;">
                    <span class="eta-day">${day}</span>
                    <div class="eta-month-year"><p>${month}</p><p>${year}</p></div>
                  </div>
                </div>
                <div>
                  <p class="eta-by">by</p>
                  <p class="eta-time">~9:00 PM</p>
                </div>
              </div>
            </div>`;
        } else if (isDelivered) {
          etaHTML = `<div class="eta-section"><p class="status-value delivered" style="margin-bottom:0;">‚úì Delivered</p></div>`;
        }

        document.getElementById('statusPanel').innerHTML = `
          <div>
            <p class="tracking-label">tracking number</p>
            <p class="tracking-num">${trackingNumber}</p>
            <div class="action-btns">
              <button onclick="navigator.clipboard.writeText('${trackingNumber}')">üìã copy</button>
              <button onclick="alert('mock: would add to dashboard (no branding)')">‚≠ê watch this parcel</button>
            </div>
            <div class="status-card">
              <p class="status-label">latest status</p>
              <p class="status-value ${isDelivered ? 'delivered' : ''}">${latest.status}</p>
              ${etaHTML}
              <div class="detail-grid">
                <div><span class="label">type: </span><span class="val">${latest.barcode_type || 'N/A'}</span></div>
                <div><span class="label">location: </span><span class="val">${latest.location || 'N/A'}</span></div>
              </div>
            </div>
          </div>
        `;
        renderTimeline();
        document.getElementById('resultsArea').style.display = 'grid';
      }

      function renderTimeline() {
        const events = showFullHistory ? allScans : allScans.slice(0, 2);
        let html = '<h3 class="timeline-title">tracking history</h3><div>';

        events.forEach((ev, i) => {
          const s = ev.status.toLowerCase();
          const isDelivered = s.includes('delivered');
          const isOFD = s.includes('out for delivery');

          let dotClass = 'dot';
          if (isDelivered) dotClass = 'dot delivered';
          else if (isOFD) dotClass = 'dot out-for-delivery';

          const connector = (i < events.length - 1) ? '<div class="connector"></div>' : '';

          let dateStr = '';
          if (ev.timestamp) {
            dateStr = ev.timestamp.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            if (ev.time && ev.time !== 'NULL' && ev.time !== '') dateStr += ' at ' + ev.time;
          }

          html += `
            <div class="timeline-row">
              <div class="timeline-col">
                <div class="${dotClass}"></div>${connector}
              </div>
              <div>
                <p class="event-status ${isDelivered ? 'delivered' : ''}">${ev.status}</p>
                ${ev.location && ev.location !== 'N/A' ? `<p class="event-detail">${ev.location}</p>` : ''}
                ${dateStr ? `<p class="event-detail">${dateStr}</p>` : ''}
              </div>
            </div>
          `;
        });

        html += '</div>';
        if (allScans.length > 2) {
          html += `<button class="show-history" onclick="toggleHistory()">${showFullHistory ? '‚àí hide full history' : '+ show full history (' + allScans.length + ' events)'}</button>`;
        }
        document.getElementById('timelinePanel').innerHTML = html;
      }

      window.toggleHistory = function() {
        showFullHistory = !showFullHistory;
        renderTimeline();
      };

      // event binding
      document.getElementById('trackBtn').addEventListener('click', handleTrack);
      document.getElementById('trackInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleTrack();
      });

      // show empty state initially
      document.getElementById('emptyState').style.display = 'block';
    })();
  </script>
</body>
</html>
