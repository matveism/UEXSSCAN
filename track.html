<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>parcel flow ‚Ä¢ live track</title>
  <!-- Leaflet CSS & JS (lightweight, open-source map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #faf9f6;
      --surface: #ffffff;
      --fg: #1e1e2f;
      --primary: #1e3a5f;          /* deep navy */
      --primary-light: #2b4c7c;
      --primary-fg: #ffffff;
      --muted: #5a6b7a;
      --border: #d9e0e8;
      --accent-soft: #ebf0f7;
      --green: #2e6b4b;
      --amber: #b45b1c;
      --dot: #1e3a5f;
      --line: #bac8d9;
      --shadow-sm: 0 6px 12px rgba(0,0,0,0.02), 0 2px 6px rgba(0,0,0,0.03);
      --shadow-focus: 0 0 0 3px rgba(30,58,95,0.15);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.5;
    }

    header {
      background: var(--primary);
      color: var(--primary-fg);
      padding: 20px 24px;
      box-shadow: inset 0 -1px 0 rgba(255,255,255,0.1);
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .header-inner svg {
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .header-inner h1 {
      font-size: 1.6rem;
      font-weight: 450;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px 50px;
    }

    .input-wrap {
      max-width: 720px;
      margin: 0 auto 30px;
    }

    .input-wrap label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: 8px;
      letter-spacing: 0.3px;
    }

    .input-row {
      display: flex;
      box-shadow: var(--shadow-sm);
      border-radius: 16px;
      overflow: hidden;
      background: var(--surface);
      border: 1px solid var(--border);
      transition: box-shadow 0.15s;
    }

    .input-row:focus-within {
      box-shadow: var(--shadow-focus), var(--shadow-sm);
      border-color: var(--primary);
    }

    .input-row input {
      flex: 1;
      padding: 16px 20px;
      border: none;
      font-size: 1.2rem;
      font-family: 'SF Mono', 'Fira Code', monospace;
      background: transparent;
      outline: none;
      color: var(--fg);
    }

    .input-row input::placeholder {
      color: #a7b8c9;
      font-weight: 300;
      font-size: 1rem;
    }

    .input-row button {
      padding: 0 28px;
      background: var(--primary);
      color: var(--primary-fg);
      font-weight: 600;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.1s;
      border-left: 1px solid rgba(255,255,255,0.15);
    }

    .input-row button:hover {
      background: var(--primary-light);
    }

    .input-row button:active {
      transform: scale(0.98);
    }

    /* layout: left column (status + map) + right timeline */
    .tracking-dashboard {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 28px;
      margin-top: 20px;
    }

    @media (max-width: 850px) {
      .tracking-dashboard {
        grid-template-columns: 1fr;
      }
    }

    /* left card */
    .left-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
    }

    .tracking-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .tracking-num {
      font-size: 1.8rem;
      font-weight: 550;
      font-family: 'SF Mono', monospace;
      margin-bottom: 10px;
      word-break: break-word;
      color: var(--primary);
    }

    .action-btns {
      display: flex;
      gap: 24px;
      font-size: 0.9rem;
      margin-bottom: 20px;
      border-bottom: 1px dashed var(--border);
      padding-bottom: 12px;
    }

    .action-btns button {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-weight: 500;
      padding: 4px 0;
      border-bottom: 1px solid transparent;
    }

    .action-btns button:hover {
      border-bottom-color: var(--primary);
    }

    .status-badge {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .status-value {
      font-size: 2.0rem;
      font-weight: 480;
      color: var(--primary);
      margin-bottom: 18px;
    }

    .status-value.delivered {
      color: var(--green);
    }

    .eta-box {
      background: var(--accent-soft);
      border-radius: 20px;
      padding: 16px 20px;
      margin: 20px 0;
    }

    .eta-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .eta-row {
      display: flex;
      align-items: baseline;
      gap: 20px;
      flex-wrap: wrap;
    }

    .eta-date {
      font-size: 2.2rem;
      font-weight: 600;
      color: var(--primary);
      line-height: 1;
    }

    .eta-month {
      font-size: 1rem;
      color: var(--muted);
    }

    .eta-time {
      font-size: 1.6rem;
      font-weight: 500;
      color: var(--primary);
    }

    /* map container */
    .map-container {
      margin-top: 28px;
      border-radius: 24px;
      overflow: hidden;
      border: 1px solid var(--border);
      height: 260px;
      background: #e9ecf0;
      position: relative;
    }

    #liveMap {
      height: 100%;
      width: 100%;
      z-index: 5;
    }

    .map-note {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 8px;
      text-align: center;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px 10px;
      border-top: 1px solid var(--border);
      padding-top: 20px;
      margin-top: 16px;
      font-size: 0.95rem;
    }

    .detail-grid .label {
      color: var(--muted);
    }

    .detail-grid .val {
      font-weight: 600;
      word-break: break-word;
    }

    /* right timeline (unchanged style) */
    .timeline-title {
      font-size: 1.5rem;
      font-weight: 440;
      color: var(--primary);
      margin-bottom: 24px;
    }

    .timeline-row {
      display: flex;
      gap: 18px;
      padding-bottom: 26px;
      position: relative;
    }

    .timeline-col {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--dot);
      margin-top: 6px;
      border: 2px solid white;
      box-shadow: 0 0 0 1px var(--line);
    }

    .dot.delivered {
      background: var(--green);
      width: 20px;
      height: 20px;
      margin-top: 3px;
      box-shadow: 0 0 0 1px var(--green);
    }

    .dot.out-for-delivery {
      background: var(--amber);
      box-shadow: 0 0 0 1px var(--amber);
    }

    .connector {
      width: 2px;
      flex: 1;
      background: var(--line);
      margin-top: 4px;
      min-height: 24px;
    }

    .event-status {
      font-weight: 650;
      font-size: 1.1rem;
    }

    .event-status.delivered { color: var(--green); }

    .event-detail {
      font-size: 0.95rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .show-history {
      margin-top: 24px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 60px;
      padding: 12px 20px;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      text-align: center;
    }

    .show-history:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .loading, .error-msg, .empty-state {
      text-align: center;
      margin-top: 50px;
    }
    .spinner {
      width: 38px;
      height: 38px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.9s infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-msg { background: #fdeded; color: #b33f3f; border-radius: 40px; padding: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
    .empty-state svg { stroke: var(--muted); opacity: 0.5; margin-bottom: 12px; }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
        <path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
        <polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/>
      </svg>
      <h1>FLOW TRACK ‚Ä¢ LIVE</h1>
    </div>
  </header>

  <main>
    <div class="input-wrap">
      <label>üîé tracking number</label>
      <div class="input-row">
        <input type="text" id="trackInput" placeholder="e.g. 1Z999AA10123456784" />
        <button id="trackBtn">track ‚Üí</button>
      </div>
    </div>

    <div id="loadingState" class="loading" style="display:none;">
      <div class="spinner"></div> contacting depot...
    </div>
    <div id="errorState" class="error-msg" style="display:none;"></div>
    <div id="emptyState" class="empty-state">
      <svg width="72" height="72" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
        <polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/>
      </svg>
      <p>enter a tracking number to view live location & status</p>
    </div>

    <!-- main dashboard (hidden until tracking) -->
    <div id="dashboard" class="tracking-dashboard" style="display:none;">
      <!-- left column: tracking info + map -->
      <div class="left-panel" id="leftPanel"></div>

      <!-- right column: timeline (will be populated) -->
      <div id="timelinePanel"></div>
    </div>
  </main>

<script>
  (function() {
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRcCfqR0Yn3zjCBHYPT0gcPNcJjQ8QwgqsIyTbySG99R3l8VPsjotxwhasGL1yh6lLToq3G0p6AOZZR/pub?gid=0&single=true&output=csv";

    // ETA offset rules (days after first scan)
    const ETA_RULES = {
      "Item Booked": 5, "Item Bagged": 4, "Item Dispatched": 3,
      "Item Received": 3, "In-Transit": 2, "Item Received at Delivery Office": 1,
      "Out for delivery": 0, "Delivered": 0
    };

    // location reverse lookup (dummy city db)
    const CITY_DATABASE = {
      "40.7128,-74.0060": "New York, NY 10001",
      "34.0522,-118.2437": "Los Angeles, CA 90001",
      "41.8781,-87.6298": "Chicago, IL 60601",
      "29.7604,-95.3698": "Houston, TX 77001",
      "39.9526,-75.1652": "Philadelphia, PA 19101",
      "37.7749,-122.4194": "San Francisco, CA 94101",
      "47.6062,-122.3321": "Seattle, WA 98101",
      "44.9907,-93.2753": "Minneapolis, MN 55408"
    };

    // ----- helper functions (parsing, coords, location) -----
    function extractCoordinates(locStr) {
      if (!locStr) return null;
      const str = locStr.trim();
      let m = str.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
      if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
      m = str.match(/^(-?\d+\.?\d*)\s+(-?\d+\.?\d*)$/);
      if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
      return null;
    }

    function convertToLocation(locationStr) {
      if (!locationStr) return null;
      // If it contains letters, it's already a text location
      if (/[a-zA-Z]/.test(locationStr)) return locationStr;
      
      const coords = extractCoordinates(locationStr);
      if (!coords) return locationStr;
      
      const lat = coords.lat.toFixed(4), lng = coords.lng.toFixed(4);
      const key = `${lat},${lng}`;
      
      if (CITY_DATABASE[key]) return CITY_DATABASE[key];
      
      // fuzzy match
      for (const [k, v] of Object.entries(CITY_DATABASE)) {
        const [dbLat, dbLng] = k.split(',').map(Number);
        if (Math.abs(dbLat - coords.lat) < 0.5 && Math.abs(dbLng - coords.lng) < 0.5) {
          return v;
        }
      }
      
      return `${coords.lat.toFixed(4)}, ${coords.lng.toFixed(4)}`;
    }

    function createTimestamp(dateStr, timeStr) {
      if (!dateStr) return null;
      
      // Remove ordinal suffixes (st, nd, rd, th)
      const clean = dateStr.replace(/(\d+)(st|nd|rd|th)/g, '$1');
      let dateTimeStr = clean;
      
      if (timeStr && timeStr !== "NULL" && timeStr !== "") {
        dateTimeStr += ' ' + timeStr;
      }
      
      const ts = new Date(dateTimeStr);
      return isNaN(ts) ? null : ts;
    }

    // Improved CSV parser that handles quoted fields and commas within fields
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current); // Add the last field
      return result.map(field => field.trim());
    }

    function parseCSV(csvText) {
      const lines = csvText.split('\n').filter(l => l.trim() !== '');
      if (!lines.length) return [];
      
      // Parse headers
      const headerLine = lines[0];
      const headers = parseCSVLine(headerLine).map(h => h.toLowerCase());
      
      const records = [];
      
      // Parse each data line
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        const rec = {};
        
        headers.forEach((h, idx) => {
          const val = values[idx] || '';
          
          if (h.includes('label') || h.includes('id')) {
            rec.label_id = val;
          } else if (h.includes('barcode')) {
            rec.barcode_type = val;
          } else if (h.includes('status')) {
            rec.status = val;
          } else if (h.includes('date')) {
            rec.date = val;
          } else if (h.includes('time')) {
            rec.time = val;
          } else if (h.includes('location')) {
            rec.raw_location = val;
            rec.location = convertToLocation(val);
          } else if (h.includes('eta')) {
            rec.eta = val;
          }
        });
        
        rec.timestamp = createTimestamp(rec.date, rec.time);
        records.push(rec);
      }
      
      return records;
    }

    function calculateETA(scans) {
      if (!scans.length) return null;
      const sortedAsc = scans.filter(s => s.timestamp).sort((a,b) => a.timestamp - b.timestamp);
      if (!sortedAsc.length) return null;
      
      const base = sortedAsc[0].timestamp;
      const sortedDesc = [...scans].filter(s => s.timestamp).sort((a,b) => b.timestamp - a.timestamp);
      const latest = sortedDesc[0] || scans[0];
      const status = latest.status || '';
      
      if (status.toLowerCase().includes('delivered')) return null;
      
      let days = 0;
      for (const [rule, d] of Object.entries(ETA_RULES)) {
        if (status.toLowerCase().includes(rule.toLowerCase())) { 
          days = d; 
          break; 
        }
      }
      
      let eta = new Date(base.getTime() + days * 86400000);
      const today = new Date(); 
      today.setHours(0,0,0,0);
      
      if (eta < today) {
        eta = days === 0 ? new Date() : new Date(today.getTime() + 86400000);
      }
      
      return eta;
    }

    // Global variables
    let allScans = [];
    let showFullHistory = false;
    let map = null;
    let marker = null;
    let currentTrackingNumber = '';

    // ----- render left panel with map container -----
    function renderLeftPanel(trackingNumber, latest, etaDate, isDelivered, coords) {
      let etaHtml = '';
      if (etaDate && !isDelivered) {
        const weekday = etaDate.toLocaleDateString('en-US', { weekday: 'long' });
        const day = etaDate.getDate();
        const month = etaDate.toLocaleDateString('en-US', { month: 'long' });
        const year = etaDate.getFullYear();
        etaHtml = `
          <div class="eta-box">
            <div class="eta-label">expected delivery</div>
            <div class="eta-row">
              <span class="eta-date">${day}</span>
              <span class="eta-month">${month} ${year}</span>
              <span class="eta-time">~9:00 PM</span>
            </div>
            <div style="margin-top:6px;">${weekday}</div>
          </div>
        `;
      } else if (isDelivered) {
        etaHtml = `<div class="eta-box"><span class="status-value delivered">‚úì Delivered</span></div>`;
      }

      const locDisplay = latest.location || 'Location not available';
      
      // Determine map status text based on actual data
      let mapStatus = 'last known location';
      if (isDelivered) {
        mapStatus = 'final delivery location';
      } else if (coords) {
        mapStatus = 'last scan location from tracking data';
      }

      document.getElementById('leftPanel').innerHTML = `
        <p class="tracking-label">tracking number</p>
        <p class="tracking-num">${trackingNumber}</p>
        <div class="action-btns">
          <button onclick="navigator.clipboard.writeText('${trackingNumber}')">üìã copy</button>
          <button onclick="alert('Watch this parcel')">‚≠ê watch</button>
        </div>
        <div class="status-badge">latest status</div>
        <div class="status-value ${isDelivered ? 'delivered' : ''}">${latest.status || 'Unknown'}</div>
        ${etaHtml}
        <div class="map-container" id="mapContainer">
          <div id="liveMap" style="height: 200px; width: 100%;"></div>
        </div>
        <div class="map-note">üìç ${mapStatus}</div>
        <div class="detail-grid">
          <div><span class="label">type: </span><span class="val">${latest.barcode_type || 'N/A'}</span></div>
          <div><span class="label">location: </span><span class="val">${locDisplay}</span></div>
        </div>
      `;

      // Initialize map after element exists
      setTimeout(() => {
        const mapDiv = document.getElementById('liveMap');
        if (!mapDiv) return;

        // Clean up old map
        if (map) { 
          map.remove(); 
          map = null; 
          marker = null; 
        }

        if (coords) {
          // Show REAL coordinates from the spreadsheet
          map = L.map('liveMap').setView([coords.lat, coords.lng], 14);
          L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
          
          // Use standard marker for all locations (no fake truck)
          marker = L.marker([coords.lat, coords.lng]).addTo(map);
          
          // Set popup text based on actual status
          if (isDelivered) {
            marker.bindPopup('‚úì Delivered at this location').openPopup();
          } else {
            marker.bindPopup(`üìç Last scan: ${latest.status || 'Package'}<br>${locDisplay}`).openPopup();
          }
        } else {
          // Default US view if no coordinates
          map = L.map('liveMap').setView([39.8283, -98.5795], 4);
          L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
          L.marker([39.8283, -98.5795]).addTo(map).bindPopup('üìç Approximate location<br>Precise coordinates not available');
        }
      }, 100);
    }

    // ----- render timeline -----
    function renderTimeline() {
      if (!allScans || allScans.length === 0) {
        document.getElementById('timelinePanel').innerHTML = '<p>No tracking history available</p>';
        return;
      }
      
      const events = showFullHistory ? allScans : allScans.slice(0, 2);
      let html = '<h3 class="timeline-title">tracking history</h3><div class="timeline">';

      events.forEach((ev, i) => {
        const s = ev.status ? ev.status.toLowerCase() : '';
        const isDelivered = s.includes('delivered');
        const isOFD = s.includes('out for delivery');

        let dotClass = 'dot';
        if (isDelivered) dotClass = 'dot delivered';
        else if (isOFD) dotClass = 'dot out-for-delivery';

        const connector = (i < events.length - 1) ? '<div class="connector"></div>' : '';

        let dateStr = 'Date not available';
        if (ev.timestamp) {
          dateStr = ev.timestamp.toLocaleDateString('en-US', { 
            month: 'long', 
            day: 'numeric', 
            year: 'numeric' 
          });
          if (ev.time && ev.time !== 'NULL' && ev.time !== '') {
            dateStr += ' at ' + ev.time;
          }
        }

        html += `
          <div class="timeline-row">
            <div class="timeline-col">
              <div class="${dotClass}"></div>${connector}
            </div>
            <div>
              <p class="event-status ${isDelivered ? 'delivered' : ''}">${ev.status || 'Unknown status'}</p>
              ${ev.location && ev.location !== 'N/A' ? `<p class="event-detail">üìç ${ev.location}</p>` : ''}
              <p class="event-detail">${dateStr}</p>
            </div>
          </div>
        `;
      });

      html += '</div>';
      
      if (allScans.length > 2) {
        html += `<button class="show-history" onclick="window.toggleHistory()">${showFullHistory ? '‚àí hide full history' : '+ show full history (' + allScans.length + ' events)'}</button>`;
      }
      
      document.getElementById('timelinePanel').innerHTML = html;
    }

    window.toggleHistory = function() {
      showFullHistory = !showFullHistory;
      renderTimeline();
    };

    // ----- main track handler -----
    async function handleTrack() {
      const input = document.getElementById('trackInput').value.trim();
      if (!input) return;

      // Show loading state
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('errorState').style.display = 'none';
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('emptyState').style.display = 'none';

      try {
        const resp = await fetch(CSV_URL);
        if (!resp.ok) throw new Error('Network error');
        
        const csv = await resp.text();
        console.log('CSV loaded, length:', csv.length);
        
        const records = parseCSV(csv);
        console.log('Parsed records:', records.length);
        
        // Case-insensitive search with trimming
        const searchTerm = input.toLowerCase().trim();
        const filtered = records.filter(r => 
          r.label_id && r.label_id.toLowerCase().trim() === searchTerm
        );

        console.log('Filtered records for', input, ':', filtered.length);

        if (filtered.length === 0) {
          document.getElementById('errorState').textContent = `‚úó No shipment found for "${input}"`;
          document.getElementById('errorState').style.display = 'block';
          document.getElementById('loadingState').style.display = 'none';
          return;
        }

        // Sort by timestamp (most recent first)
        const valid = filtered
          .filter(r => r.timestamp)
          .sort((a, b) => b.timestamp - a.timestamp);
        
        allScans = valid.length ? valid : filtered;
        currentTrackingNumber = input;
        showFullHistory = false;

        // Get latest scan
        const latest = allScans[0];
        
        // Extract REAL coordinates from raw_location
        let coords = null;
        if (latest.raw_location) {
          coords = extractCoordinates(latest.raw_location);
          console.log('Real coordinates from data:', coords);
        }
        
        const eta = calculateETA(allScans);
        const isDelivered = latest.status ? latest.status.toLowerCase().includes('delivered') : false;

        // Show dashboard with REAL location
        document.getElementById('dashboard').style.display = 'grid';
        renderLeftPanel(input, latest, eta, isDelivered, coords);
        renderTimeline();

      } catch (err) {
        console.error('Error:', err);
        document.getElementById('errorState').textContent = err.message || 'Failed to load tracking data';
        document.getElementById('errorState').style.display = 'block';
      } finally {
        document.getElementById('loadingState').style.display = 'none';
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const trackBtn = document.getElementById('trackBtn');
      const trackInput = document.getElementById('trackInput');
      
      if (trackBtn) {
        trackBtn.addEventListener('click', handleTrack);
      }
      
      if (trackInput) {
        trackInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') handleTrack();
        });
      }
      
      // Initial empty state
      document.getElementById('emptyState').style.display = 'block';
    });
  })();
</script>
</body>
</html>
