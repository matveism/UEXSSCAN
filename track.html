<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Package Tracker</title>
<meta name="description" content="Track your package delivery status" />
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #ffffff;
    --fg: #2d3748;
    --primary: hsl(220, 60%, 30%);
    --primary-fg: #ffffff;
    --muted: hsl(215, 15%, 50%);
    --border: hsl(214, 30%, 91%);
    --delivery-bg: hsl(210, 40%, 96%);
    --destructive: hsl(0, 84%, 60%);
    --green: #16a34a;
    --orange: #f97316;
    --dot: hsl(220, 60%, 30%);
    --line: hsl(220, 20%, 80%);
  }
  body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--fg); }
  header { background: var(--primary); color: var(--primary-fg); padding: 16px 24px; }
  .header-inner { max-width: 1024px; margin: 0 auto; display: flex; align-items: center; gap: 12px; }
  .header-inner h1 { font-size: 20px; font-weight: 700; letter-spacing: 1px; }
  main { max-width: 1024px; margin: 0 auto; padding: 32px 16px; }
  /* Tracking Input */
  .input-wrap { max-width: 640px; margin: 0 auto; }
  .input-wrap label { display: block; font-size: 14px; font-weight: 600; color: var(--muted); margin-bottom: 8px; }
  .input-row { display: flex; }
  .input-row input { flex: 1; padding: 12px 16px; border: 2px solid var(--border); border-right: none; border-radius: 6px 0 0 6px; font-size: 18px; font-family: monospace; outline: none; }
  .input-row input:focus { border-color: var(--primary); }
  .input-row button { padding: 12px 24px; background: var(--primary); color: var(--primary-fg); font-weight: 700; border: none; border-radius: 0 6px 6px 0; cursor: pointer; font-size: 16px; }
  .input-row button:hover { opacity: 0.9; }
  .input-row button:disabled { opacity: 0.5; cursor: not-allowed; }
  /* Grid */
  .results-grid { margin-top: 32px; display: grid; grid-template-columns: 1fr 1fr; gap: 32px; }
  @media (max-width: 768px) { .results-grid { grid-template-columns: 1fr; } }
  /* Delivery Status */
  .tracking-label { font-size: 14px; color: var(--muted); margin-bottom: 4px; }
  .tracking-num { font-size: 24px; font-weight: 700; font-family: monospace; letter-spacing: 1px; margin-bottom: 8px; }
  .action-btns { display: flex; gap: 16px; font-size: 14px; color: var(--primary); margin-bottom: 24px; }
  .action-btns button { background: none; border: none; color: var(--primary); cursor: pointer; font-weight: 500; }
  .action-btns button:hover { text-decoration: underline; }
  .status-card { background: var(--delivery-bg); border: 1px solid var(--border); border-radius: 8px; padding: 24px; }
  .status-label { font-size: 14px; font-weight: 600; color: var(--muted); margin-bottom: 4px; }
  .status-value { font-size: 20px; font-weight: 700; color: var(--primary); margin-bottom: 16px; }
  .status-value.delivered { color: var(--green); }
  .eta-section { margin-bottom: 16px; }
  .eta-label { font-size: 14px; font-weight: 600; color: var(--muted); margin-bottom: 8px; }
  .eta-display { display: flex; align-items: flex-start; gap: 24px; }
  .eta-weekday { font-size: 18px; font-weight: 700; color: var(--primary); text-transform: uppercase; }
  .eta-day { font-size: 40px; font-weight: 900; color: var(--primary); line-height: 1; }
  .eta-month-year { font-size: 14px; color: var(--muted); }
  .eta-by { font-size: 14px; color: var(--muted); }
  .eta-time { font-size: 20px; font-weight: 700; color: var(--primary); }
  .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px; }
  .detail-grid .label { color: var(--muted); }
  .detail-grid .val { font-weight: 600; }
  /* Timeline */
  .timeline-title { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 16px; }
  .timeline-row { display: flex; gap: 16px; padding-bottom: 24px; }
  .timeline-row:last-child { padding-bottom: 0; }
  .timeline-col { display: flex; flex-direction: column; align-items: center; }
  .dot { width: 12px; height: 12px; border-radius: 50%; background: var(--dot); margin-top: 4px; flex-shrink: 0; }
  .dot.delivered { width: 20px; height: 20px; background: var(--green); margin-top: 2px; display: flex; align-items: center; justify-content: center; }
  .dot.delivered svg { width: 12px; height: 12px; }
  .dot.out-for-delivery { background: var(--orange); }
  .connector { width: 2px; flex: 1; background: var(--line); margin-top: 4px; }
  .event-status { font-weight: 700; font-size: 14px; }
  .event-status.delivered { color: var(--green); }
  .event-detail { font-size: 14px; color: var(--muted); }
  .show-history { margin-top: 16px; background: none; border: none; color: var(--primary); font-weight: 700; font-size: 14px; cursor: pointer; }
  .show-history:hover { text-decoration: underline; }
  /* States */
  .loading { margin-top: 32px; text-align: center; color: var(--muted); }
  .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 8px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .error-msg { margin-top: 32px; max-width: 640px; margin-left: auto; margin-right: auto; background: hsl(0 84% 60% / 0.1); border: 1px solid hsl(0 84% 60% / 0.3); color: var(--destructive); border-radius: 6px; padding: 16px; text-align: center; font-weight: 600; }
  .empty-state { margin-top: 64px; text-align: center; color: var(--muted); opacity: 0.5; }
  .empty-state svg { margin: 0 auto 16px; }
  .empty-state p { font-size: 18px; }
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/></svg>
    <h1>PACKAGE TRACKER</h1>
  </div>
</header>
<main>
  <div class="input-wrap">
    <label>Tracking Number:</label>
    <div class="input-row">
      <input type="text" id="trackInput" placeholder="Enter your tracking number" />
      <button id="trackBtn" onclick="handleTrack()">üîç Track</button>
    </div>
  </div>
  <div id="loadingState" class="loading" style="display:none;">
    <div class="spinner"></div>
    Searching...
  </div>
  <div id="errorState" class="error-msg" style="display:none;"></div>
  <div id="emptyState" class="empty-state">
    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/></svg>
    <p>Enter a tracking number to get started</p>
  </div>
  <div id="resultsArea" class="results-grid" style="display:none;">
    <div id="statusPanel"></div>
    <div id="timelinePanel"></div>
  </div>
</main>
<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRcCfqR0Yn3zjCBHYPT0gcPNcJjQ8QwgqsIyTbySG99R3l8VPsjotxwhasGL1yh6lLToq3G0p6AOZZR/pub?gid=0&single=true&output=csv";

// Updated ETA_OFFSETS with new statuses from the image
const ETA_OFFSETS = {
  "Item Booked": 7,
  "Item Bagged": 6,
  "Item Dispatched": 5,
  "Item Received": 4,
  "In-Transit": 3,
  "Item Received at Delivery Office": 2,
  "Out for Delivery": 1,
  "Delivered": 0
};

let allScans = [];
let showFullHistory = false;

function parseCSV(csvText) {
  const lines = csvText.split('\n');
  const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
  
  return lines.slice(1)
    .filter(line => line.trim())
    .map(line => {
      // Handle quoted fields properly
      const values = [];
      let inQuote = false;
      let currentValue = '';
      
      for (let char of line) {
        if (char === '"') {
          inQuote = !inQuote;
        } else if (char === ',' && !inQuote) {
          values.push(currentValue);
          currentValue = '';
        } else {
          currentValue += char;
        }
      }
      values.push(currentValue); // Add the last value
      
      const record = {};
      
      headers.forEach((header, index) => {
        const value = (values[index] || '').trim().replace(/"/g, '');
        const headerLower = header.toLowerCase().trim();
        
        if (headerLower === 'label_id') {
          record.label_id = value;
        } 
        else if (headerLower === 'barcode_type') {
          record.barcode_type = value;
        }
        else if (headerLower === 'status') {
          record.status = value;
        }
        else if (headerLower === 'date') {
          record.date = value;
        }
        else if (headerLower === 'time') {
          record.time = value;
        }
        else if (headerLower === 'location') {
          record.location = value;
        }
        else if (headerLower === 'eta') {
          record.eta = value;
        }
      });
      
      // Create timestamp from date and time
      if (record.date) {
        let dateStr = record.date;
        if (record.time && record.time !== "NULL" && record.time !== "") {
          dateStr += ' ' + record.time;
        }
        record.timestamp = new Date(dateStr);
      }
      
      return record;
    });
}

function calculateETA(scans) {
  if (!scans.length) return null;
  
  // Sort by timestamp (oldest first for base date)
  const sorted = [...scans].sort((a, b) => new Date(a.timestamp || 0) - new Date(b.timestamp || 0));
  const baseDate = new Date(sorted[0].timestamp);
  if (isNaN(baseDate)) return null;
  
  // Get latest status for ETA calculation
  const latestScan = scans.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0))[0];
  const latestStatus = latestScan.status;
  
  // Find matching rule (case insensitive partial match)
  let daysToAdd = 5; // Default to 5 days if no match
  for (const [status, days] of Object.entries(ETA_OFFSETS)) {
    if (latestStatus.toLowerCase().includes(status.toLowerCase())) {
      daysToAdd = days;
      break;
    }
  }
  
  // If delivered, return null
  if (latestStatus.toLowerCase().includes("delivered")) {
    return null;
  }
  
  return new Date(baseDate.getTime() + daysToAdd * 86400000);
}

async function handleTrack() {
  const input = document.getElementById("trackInput").value.trim();
  if (!input) return;
  
  document.getElementById("loadingState").style.display = "block";
  document.getElementById("errorState").style.display = "none";
  document.getElementById("resultsArea").style.display = "none";
  document.getElementById("emptyState").style.display = "none";
  showFullHistory = false;
  
  try {
    const response = await fetch(CSV_URL);
    if (!response.ok) throw new Error("Failed to fetch tracking data");
    
    const csvText = await response.text();
    const allRecords = parseCSV(csvText);
    
    // Filter records by label_id (tracking number) - case insensitive
    const filtered = allRecords.filter(r => 
      r.label_id && r.label_id.toLowerCase() === input.toLowerCase()
    );
    
    if (!filtered.length) {
      document.getElementById("errorState").textContent = 'No tracking data found for "' + input + '"';
      document.getElementById("errorState").style.display = "block";
      return;
    }
    
    // Sort by timestamp (newest first)
    filtered.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
    allScans = filtered;
    renderResults(input);
  } catch (err) {
    document.getElementById("errorState").textContent = err.message || "Failed to connect";
    document.getElementById("errorState").style.display = "block";
  } finally {
    document.getElementById("loadingState").style.display = "none";
  }
}

function renderResults(trackingNumber) {
  const latest = allScans[0];
  const eta = calculateETA(allScans);
  const isDelivered = latest.status.toLowerCase().includes("delivered");
  
  // Status panel
  let etaHTML = "";
  if (eta && !isNaN(eta) && !isDelivered) {
    const weekday = eta.toLocaleDateString("en-US", { weekday: "long" });
    const day = eta.getDate();
    const month = eta.toLocaleDateString("en-US", { month: "long" });
    const year = eta.getFullYear();
    etaHTML = `
      <div class="eta-section">
        <p class="eta-label">Expected Delivery on</p>
        <div class="eta-display">
          <div>
            <p class="eta-weekday">${weekday}</p>
            <div style="display:flex;align-items:baseline;gap:8px;">
              <span class="eta-day">${day}</span>
              <div class="eta-month-year"><p>${month}</p><p>${year}</p></div>
            </div>
          </div>
          <div>
            <p class="eta-by">by</p>
            <p class="eta-time">9:00 PM</p>
          </div>
        </div>
      </div>`;
  } else if (isDelivered) {
    etaHTML = `
      <div class="eta-section">
        <p class="status-value delivered" style="margin-bottom:0;">‚úì Delivered</p>
      </div>`;
  }
  
  document.getElementById("statusPanel").innerHTML = `
    <div>
      <p class="tracking-label">Tracking Number:</p>
      <p class="tracking-num">${trackingNumber}</p>
      <div class="action-btns">
        <button onclick="navigator.clipboard.writeText('${trackingNumber}')">üìã Copy</button>
        <button>‚≠ê Add to Informed Delivery</button>
      </div>
      <div class="status-card">
        <p class="status-label">Latest Status</p>
        <p class="status-value ${isDelivered ? 'delivered' : ''}">${latest.status}</p>
        ${etaHTML}
        <div class="detail-grid">
          <div><span class="label">Type: </span><span class="val">${latest.barcode_type || "N/A"}</span></div>
          <div><span class="label">Location: </span><span class="val">${latest.location || "N/A"}</span></div>
        </div>
      </div>
    </div>`;
  
  renderTimeline();
  document.getElementById("resultsArea").style.display = "grid";
}

function renderTimeline() {
  const events = showFullHistory ? allScans : allScans.slice(0, 2);
  let html = '<h3 class="timeline-title">Tracking History</h3><div>';
  
  events.forEach((ev, i) => {
    const s = ev.status.toLowerCase();
    const isDelivered = s.includes("delivered");
    const isOFD = s.includes("out for delivery");
    const date = ev.timestamp ? new Date(ev.timestamp) : null;
    
    let dotHTML;
    if (isDelivered) {
      dotHTML = `<div class="dot delivered"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg></div>`;
    } else if (isOFD) {
      dotHTML = `<div class="dot out-for-delivery"></div>`;
    } else {
      dotHTML = `<div class="dot"></div>`;
    }
    
    const connector = i < events.length - 1 ? '<div class="connector"></div>' : '';
    const dateStr = date ? date.toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" }) + ", " + date.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit", hour12: true }) : "";
    
    html += `
      <div class="timeline-row">
        <div class="timeline-col">${dotHTML}${connector}</div>
        <div>
          <p class="event-status ${isDelivered ? 'delivered' : ''}">${ev.status}</p>
          ${ev.location ? '<p class="event-detail">' + ev.location + '</p>' : ''}
          ${dateStr ? '<p class="event-detail">' + dateStr + '</p>' : ''}
        </div>
      </div>`;
  });
  
  html += '</div>';
  
  if (allScans.length > 2) {
    html += `<button class="show-history" onclick="toggleHistory()">${showFullHistory ? 'Hide Tracking History' : 'Show Full Tracking History (' + allScans.length + ' events)'}</button>`;
  }
  
  document.getElementById("timelinePanel").innerHTML = html;
}

function toggleHistory() {
  showFullHistory = !showFullHistory;
  renderTimeline();
}

document.getElementById("trackInput").addEventListener("keydown", function(e) {
  if (e.key === "Enter") handleTrack();
});
</script>
</body>
</html>
