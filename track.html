<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>parcel flow ‚Ä¢ live track</title>
  <!-- Leaflet CSS & JS (lightweight, open-source map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #faf9f6;
      --surface: #ffffff;
      --fg: #1e1e2f;
      --primary: #1e3a5f;          /* deep navy */
      --primary-light: #2b4c7c;
      --primary-fg: #ffffff;
      --muted: #5a6b7a;
      --border: #d9e0e8;
      --accent-soft: #ebf0f7;
      --green: #2e6b4b;
      --amber: #b45b1c;
      --dot: #1e3a5f;
      --line: #bac8d9;
      --shadow-sm: 0 6px 12px rgba(0,0,0,0.02), 0 2px 6px rgba(0,0,0,0.03);
      --shadow-focus: 0 0 0 3px rgba(30,58,95,0.15);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.5;
    }

    header {
      background: var(--primary);
      color: var(--primary-fg);
      padding: 20px 24px;
      box-shadow: inset 0 -1px 0 rgba(255,255,255,0.1);
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .header-inner svg {
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .header-inner h1 {
      font-size: 1.6rem;
      font-weight: 450;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px 50px;
    }

    .input-wrap {
      max-width: 720px;
      margin: 0 auto 30px;
    }

    .input-wrap label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--muted);
      margin-bottom: 8px;
      letter-spacing: 0.3px;
    }

    .input-row {
      display: flex;
      box-shadow: var(--shadow-sm);
      border-radius: 16px;
      overflow: hidden;
      background: var(--surface);
      border: 1px solid var(--border);
      transition: box-shadow 0.15s;
    }

    .input-row:focus-within {
      box-shadow: var(--shadow-focus), var(--shadow-sm);
      border-color: var(--primary);
    }

    .input-row input {
      flex: 1;
      padding: 16px 20px;
      border: none;
      font-size: 1.2rem;
      font-family: 'SF Mono', 'Fira Code', monospace;
      background: transparent;
      outline: none;
      color: var(--fg);
    }

    .input-row input::placeholder {
      color: #a7b8c9;
      font-weight: 300;
      font-size: 1rem;
    }

    .input-row button {
      padding: 0 28px;
      background: var(--primary);
      color: var(--primary-fg);
      font-weight: 600;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.1s;
      border-left: 1px solid rgba(255,255,255,0.15);
    }

    .input-row button:hover {
      background: var(--primary-light);
    }

    .input-row button:active {
      transform: scale(0.98);
    }

    /* layout: left column (status + map) + right timeline */
    .tracking-dashboard {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 28px;
      margin-top: 20px;
    }

    @media (max-width: 850px) {
      .tracking-dashboard {
        grid-template-columns: 1fr;
      }
    }

    /* left card */
    .left-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
    }

    .tracking-label {
      font-size: 0.85rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .tracking-num {
      font-size: 1.8rem;
      font-weight: 550;
      font-family: 'SF Mono', monospace;
      margin-bottom: 10px;
      word-break: break-word;
      color: var(--primary);
    }

    .action-btns {
      display: flex;
      gap: 24px;
      font-size: 0.9rem;
      margin-bottom: 20px;
      border-bottom: 1px dashed var(--border);
      padding-bottom: 12px;
    }

    .action-btns button {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      font-weight: 500;
      padding: 4px 0;
      border-bottom: 1px solid transparent;
    }

    .action-btns button:hover {
      border-bottom-color: var(--primary);
    }

    .status-badge {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .status-value {
      font-size: 2.0rem;
      font-weight: 480;
      color: var(--primary);
      margin-bottom: 18px;
    }

    .status-value.delivered {
      color: var(--green);
    }

    .eta-box {
      background: var(--accent-soft);
      border-radius: 20px;
      padding: 16px 20px;
      margin: 20px 0;
    }

    .eta-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .eta-row {
      display: flex;
      align-items: baseline;
      gap: 20px;
      flex-wrap: wrap;
    }

    .eta-date {
      font-size: 2.2rem;
      font-weight: 600;
      color: var(--primary);
      line-height: 1;
    }

    .eta-month {
      font-size: 1rem;
      color: var(--muted);
    }

    .eta-time {
      font-size: 1.6rem;
      font-weight: 500;
      color: var(--primary);
    }

    /* map container */
    .map-container {
      margin-top: 28px;
      border-radius: 24px;
      overflow: hidden;
      border: 1px solid var(--border);
      height: 260px;
      background: #e9ecf0;
      position: relative;
    }

    #liveMap {
      height: 100%;
      width: 100%;
      z-index: 5;
    }

    .map-note {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 8px;
      text-align: center;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px 10px;
      border-top: 1px solid var(--border);
      padding-top: 20px;
      margin-top: 16px;
      font-size: 0.95rem;
    }

    .detail-grid .label {
      color: var(--muted);
    }

    .detail-grid .val {
      font-weight: 600;
      word-break: break-word;
    }

    /* right timeline (unchanged style) */
    .timeline-title {
      font-size: 1.5rem;
      font-weight: 440;
      color: var(--primary);
      margin-bottom: 24px;
    }

    .timeline-row {
      display: flex;
      gap: 18px;
      padding-bottom: 26px;
      position: relative;
    }

    .timeline-col {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--dot);
      margin-top: 6px;
      border: 2px solid white;
      box-shadow: 0 0 0 1px var(--line);
    }

    .dot.delivered {
      background: var(--green);
      width: 20px;
      height: 20px;
      margin-top: 3px;
      box-shadow: 0 0 0 1px var(--green);
    }

    .dot.out-for-delivery {
      background: var(--amber);
      box-shadow: 0 0 0 1px var(--amber);
    }

    .connector {
      width: 2px;
      flex: 1;
      background: var(--line);
      margin-top: 4px;
      min-height: 24px;
    }

    .event-status {
      font-weight: 650;
      font-size: 1.1rem;
    }

    .event-status.delivered { color: var(--green); }

    .event-detail {
      font-size: 0.95rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .show-history {
      margin-top: 24px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 60px;
      padding: 12px 20px;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      text-align: center;
    }

    .show-history:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .loading, .error-msg, .empty-state {
      text-align: center;
      margin-top: 50px;
    }
    .spinner {
      width: 38px;
      height: 38px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.9s infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-msg { background: #fdeded; color: #b33f3f; border-radius: 40px; padding: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
    .empty-state svg { stroke: var(--muted); opacity: 0.5; margin-bottom: 12px; }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
        <path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
        <polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/>
      </svg>
      <h1>FLOW TRACK ‚Ä¢ LIVE</h1>
    </div>
  </header>

  <main>
    <div class="input-wrap">
      <label>üîé tracking number</label>
      <div class="input-row">
        <input type="text" id="trackInput" placeholder="e.g. 1Z999AA10123456784" />
        <button id="trackBtn">track ‚Üí</button>
      </div>
    </div>

    <div id="loadingState" class="loading" style="display:none;">
      <div class="spinner"></div> contacting depot...
    </div>
    <div id="errorState" class="error-msg" style="display:none;"></div>
    <div id="emptyState" class="empty-state">
      <svg width="72" height="72" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M16.5 9.4 7.55 4.24"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
        <polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/>
      </svg>
      <p>enter a tracking number to view live location & status</p>
    </div>

    <!-- main dashboard (hidden until tracking) -->
    <div id="dashboard" class="tracking-dashboard" style="display:none;">
      <!-- left column: tracking info + map -->
      <div class="left-panel" id="leftPanel"></div>

      <!-- right column: timeline (will be populated) -->
      <div id="timelinePanel"></div>
    </div>
  </main>

<script>
  (function() {
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRcCfqR0Yn3zjCBHYPT0gcPNcJjQ8QwgqsIyTbySG99R3l8VPsjotxwhasGL1yh6lLToq3G0p6AOZZR/pub?gid=0&single=true&output=csv";
    
    // For real-time tracking - you need a WebSocket server
    const WS_URL = "wss://your-tracking-server.com/ws"; // REPLACE WITH YOUR ACTUAL WEBSOCKET SERVER
    
    // Global variables
    let allScans = [];
    let showFullHistory = false;
    let map = null;
    let marker = null;
    let watchInterval = null;
    let currentTrackingNumber = '';
    let socket = null;
    let realtimeCoords = null;
    let pathLine = null;
    let pathPoints = [];

    // ----- WebSocket connection for real-time GPS -----
    function connectWebSocket(trackingNumber) {
      if (!window.WebSocket) {
        console.log("WebSocket not supported");
        return;
      }

      // Close existing connection
      if (socket) {
        socket.close();
      }

      // Connect to your tracking server
      // You need a REAL WebSocket server that receives GPS data from courier devices
      socket = new WebSocket(WS_URL);
      
      socket.onopen = function() {
        console.log("Connected to tracking server");
        // Subscribe to this specific tracking number
        socket.send(JSON.stringify({
          type: "subscribe",
          trackingNumber: trackingNumber
        }));
      };
      
      socket.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          console.log("Real-time GPS update:", data);
          
          if (data.type === "location" && data.trackingNumber === trackingNumber) {
            // Update real-time position
            realtimeCoords = {
              lat: data.lat,
              lng: data.lng
            };
            
            // Update map with real position
            updateRealtimePosition(realtimeCoords, data.speed, data.heading);
          }
        } catch (e) {
          console.error("Error parsing WebSocket message:", e);
        }
      };
      
      socket.onerror = function(error) {
        console.error("WebSocket error:", error);
        // Fall back to simulated movement if real tracking fails
        startSimulatedTracking();
      };
      
      socket.onclose = function() {
        console.log("Disconnected from tracking server");
      };
    }
    
    // ----- Update map with REAL GPS position -----
    function updateRealtimePosition(coords, speed, heading) {
      if (!map || !marker) return;
      
      // Update marker position
      marker.setLatLng([coords.lat, coords.lng]);
      
      // Update path (breadcrumb trail)
      pathPoints.push([coords.lat, coords.lng]);
      if (pathPoints.length > 50) pathPoints.shift(); // Keep last 50 points
      
      if (pathLine) {
        pathLine.setLatLngs(pathPoints);
      } else {
        pathLine = L.polyline(pathPoints, { color: 'blue', weight: 3 }).addTo(map);
      }
      
      // Update marker icon based on speed/movement
      const speedKph = speed || 0;
      let icon = L.divIcon({
        className: 'custom-marker',
        html: speedKph > 0 ? 'üöö üí®' : 'üöö',
        iconSize: [30, 30],
        popupAnchor: [0, -15]
      });
      marker.setIcon(icon);
      
      // Update popup with live info
      marker.bindPopup(`
        <b>Live Tracking</b><br>
        Speed: ${speedKph} km/h<br>
        Last update: ${new Date().toLocaleTimeString()}<br>
        Tracking #: ${currentTrackingNumber}
      `).openPopup();
      
      // Center map on vehicle if moving
      if (speedKph > 0) {
        map.panTo([coords.lat, coords.lng]);
      }
    }
    
    // ----- Fallback simulation (remove this in production) -----
    function startSimulatedTracking(initialCoords) {
      if (!initialCoords) return;
      
      let step = 0;
      const path = [
        [initialCoords.lat, initialCoords.lng],
        [initialCoords.lat + 0.001, initialCoords.lng - 0.0005],
        [initialCoords.lat + 0.002, initialCoords.lng - 0.0012],
        [initialCoords.lat + 0.0025, initialCoords.lng - 0.002],
        [initialCoords.lat + 0.003, initialCoords.lng - 0.0028],
      ];
      
      if (watchInterval) clearInterval(watchInterval);
      
      watchInterval = setInterval(() => {
        step = (step + 1) % path.length;
        const pos = path[step];
        if (marker) {
          marker.setLatLng(pos);
          map.panTo(pos);
          
          // Update path
          pathPoints.push(pos);
          if (pathPoints.length > 50) pathPoints.shift();
          if (pathLine) {
            pathLine.setLatLngs(pathPoints);
          }
        }
      }, 3500);
    }

    function stopLiveTracking() {
      if (watchInterval) {
        clearInterval(watchInterval);
        watchInterval = null;
      }
      if (socket) {
        socket.close();
        socket = null;
      }
    }

    // ----- extract coordinates from CSV data -----
    function extractCoordinates(locStr) {
      if (!locStr) return null;
      const str = locStr.trim();
      let m = str.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
      if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
      m = str.match(/^(-?\d+\.?\d*)\s+(-?\d+\.?\d*)$/);
      if (m) return { lat: parseFloat(m[1]), lng: parseFloat(m[2]) };
      return null;
    }

    // ----- CSV parsing (same as before) -----
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result.map(field => field.trim().replace(/^"|"$/g, ''));
    }

    function createTimestamp(dateStr, timeStr) {
      if (!dateStr || dateStr === "NULL") return null;
      
      // Handle "6-Mar-2025" format
      const parts = dateStr.split(/[-\/]/);
      if (parts.length === 3) {
        const day = parseInt(parts[0]);
        const month = parts[1];
        const year = parseInt(parts[2]);
        
        const monthMap = {
          'jan':0,'feb':1,'mar':2,'apr':3,'may':4,'jun':5,
          'jul':6,'aug':7,'sep':8,'oct':9,'nov':10,'dec':11
        };
        
        if (monthMap[month.toLowerCase().substring(0,3)] !== undefined) {
          let ts = new Date(year, monthMap[month.toLowerCase().substring(0,3)], day);
          
          if (timeStr && timeStr !== "NULL") {
            const timeParts = timeStr.match(/(\d+):(\d+)/);
            if (timeParts) {
              ts.setHours(parseInt(timeParts[1]), parseInt(timeParts[2]), 0);
            }
          }
          return ts;
        }
      }
      
      let ts = new Date(dateStr);
      return isNaN(ts) ? null : ts;
    }

    function parseCSV(csvText) {
      const lines = csvText.split('\n').filter(l => l.trim());
      if (!lines.length) return [];
      
      const headers = parseCSVLine(lines[0]).map(h => h.toLowerCase());
      const records = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        const rec = {};
        
        headers.forEach((h, idx) => {
          const val = values[idx] || '';
          if (h.includes('label') || h.includes('id') || h === 'tracking') {
            rec.label_id = val;
          } else if (h.includes('barcode')) {
            rec.barcode_type = val;
          } else if (h.includes('status')) {
            rec.status = val;
          } else if (h.includes('date')) {
            rec.date = val;
          } else if (h.includes('time')) {
            rec.time = val;
          } else if (h.includes('location')) {
            rec.raw_location = val;
            rec.location = val;
          }
        });
        
        rec.timestamp = createTimestamp(rec.date, rec.time);
        records.push(rec);
      }
      
      return records;
    }

    // ----- render left panel with live tracking map -----
    function renderLeftPanel(trackingNumber, latest, etaDate, isDelivered, initialCoords) {
      let etaHtml = '';
      if (etaDate && !isDelivered) {
        etaHtml = `
          <div class="eta-box">
            <div class="eta-label">expected delivery</div>
            <div class="eta-row">
              <span class="eta-date">${etaDate.getDate()}</span>
              <span class="eta-month">${etaDate.toLocaleDateString('en-US', { month: 'long' })} ${etaDate.getFullYear()}</span>
              <span class="eta-time">~9:00 PM</span>
            </div>
          </div>
        `;
      }

      document.getElementById('leftPanel').innerHTML = `
        <p class="tracking-label">tracking number</p>
        <p class="tracking-num">${trackingNumber}</p>
        <div class="action-btns">
          <button onclick="navigator.clipboard.writeText('${trackingNumber}')">üìã copy</button>
          <button onclick="alert('Watch this parcel')">‚≠ê watch</button>
        </div>
        <div class="status-badge">live tracking</div>
        <div class="status-value ${isDelivered ? 'delivered' : ''}" style="color: #2ecc71; font-weight: bold;">
          ${latest.status || 'Unknown'} ${!isDelivered ? 'üî¥ LIVE' : ''}
        </div>
        ${etaHtml}
        <div class="map-container" id="mapContainer" style="height: 300px; width: 100%; margin: 15px 0; border-radius: 8px; border: 2px solid #2ecc71;"></div>
        <div class="map-note" id="liveStatus">
          üöö ${initialCoords ? 'Waiting for GPS signal...' : 'No GPS data available'}
        </div>
        <div class="detail-grid">
          <div><span class="label">last scan: </span><span class="val">${latest.location || 'N/A'}</span></div>
          <div><span class="label">last update: </span><span class="val" id="lastUpdateTime">${new Date().toLocaleTimeString()}</span></div>
        </div>
      `;

      // Initialize Leaflet map
      setTimeout(() => {
        if (map) {
          map.remove();
        }

        const mapDiv = document.getElementById('mapContainer');
        if (!mapDiv) return;

        // Default view
        const defaultView = initialCoords ? [initialCoords.lat, initialCoords.lng] : [39.8283, -98.5795];
        map = L.map('mapContainer').setView(defaultView, initialCoords ? 15 : 4);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // Create vehicle marker
        const vehicleIcon = L.divIcon({
          className: 'vehicle-marker',
          html: 'üöö',
          iconSize: [32, 32],
          popupAnchor: [0, -16]
        });

        marker = L.marker(defaultView, {
          icon: vehicleIcon,
          zIndexOffset: 1000
        }).addTo(map);

        marker.bindPopup(`
          <b>Courier Vehicle</b><br>
          Tracking: ${trackingNumber}<br>
          Status: ${latest.status}
        `).openPopup();

        // Add initial path point
        pathPoints = [defaultView];
        pathLine = L.polyline(pathPoints, { color: '#2ecc71', weight: 4, opacity: 0.7 }).addTo(map);

        // Connect to REAL tracking server
        if (!isDelivered && initialCoords) {
          document.getElementById('liveStatus').innerHTML = 'üü¢ Connecting to live GPS...';
          connectWebSocket(trackingNumber);
          
          // Start with initial position
          realtimeCoords = initialCoords;
          updateRealtimePosition(initialCoords, 0, 0);
        }
      }, 100);
    }

    // ----- render timeline -----
    function renderTimeline() {
      if (!allScans || !allScans.length) {
        document.getElementById('timelinePanel').innerHTML = '<p>No tracking history</p>';
        return;
      }
      
      const events = showFullHistory ? allScans : allScans.slice(0, 5);
      let html = '<h3 class="timeline-title">tracking history</h3><div class="timeline">';

      events.forEach((ev, i) => {
        const s = ev.status ? ev.status.toLowerCase() : '';
        const isDelivered = s.includes('delivered');
        const isOFD = s.includes('out for delivery');

        let dotClass = 'dot';
        if (isDelivered) dotClass = 'dot delivered';
        else if (isOFD) dotClass = 'dot out-for-delivery';

        const connector = (i < events.length - 1) ? '<div class="connector"></div>' : '';

        let dateStr = 'Date N/A';
        if (ev.timestamp) {
          dateStr = ev.timestamp.toLocaleString('en-US', { 
            month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
          });
        }

        html += `
          <div class="timeline-row">
            <div class="timeline-col"><div class="${dotClass}"></div>${connector}</div>
            <div>
              <p class="event-status">${ev.status || 'Unknown'}</p>
              ${ev.location ? `<p class="event-detail">üìç ${ev.location}</p>` : ''}
              <p class="event-detail">üìÖ ${dateStr}</p>
            </div>
          </div>
        `;
      });

      html += '</div>';
      if (allScans.length > 5) {
        html += `<button onclick="window.toggleHistory()">${showFullHistory ? '‚àí hide' : '+ show all (${allScans.length})'}</button>`;
      }
      
      document.getElementById('timelinePanel').innerHTML = html;
    }

    window.toggleHistory = function() {
      showFullHistory = !showFullHistory;
      renderTimeline();
    };

    // ----- main track handler -----
    async function handleTrack() {
      const input = document.getElementById('trackInput').value.trim();
      if (!input) return;

      stopLiveTracking();
      
      document.getElementById('loadingState').style.display = 'block';
      document.getElementById('errorState').style.display = 'none';
      document.getElementById('dashboard').style.display = 'none';

      try {
        const resp = await fetch(CSV_URL);
        const csv = await resp.text();
        const records = parseCSV(csv);
        
        const filtered = records.filter(r => 
          r.label_id && r.label_id.toLowerCase().trim() === input.toLowerCase().trim()
        );

        if (!filtered.length) {
          document.getElementById('errorState').textContent = `‚úó No shipment for "${input}"`;
          document.getElementById('errorState').style.display = 'block';
          return;
        }

        allScans = filtered.sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
        currentTrackingNumber = input;
        showFullHistory = false;

        const latest = allScans[0];
        const initialCoords = extractCoordinates(latest.raw_location);
        const eta = calculateETA(allScans);
        const isDelivered = latest.status.toLowerCase().includes('delivered');

        document.getElementById('dashboard').style.display = 'grid';
        renderLeftPanel(input, latest, eta, isDelivered, initialCoords);
        renderTimeline();

      } catch (err) {
        document.getElementById('errorState').textContent = err.message;
        document.getElementById('errorState').style.display = 'block';
      } finally {
        document.getElementById('loadingState').style.display = 'none';
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('trackBtn').addEventListener('click', handleTrack);
      document.getElementById('trackInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleTrack();
      });
    });

  })();
</script>
</body>
</html>
